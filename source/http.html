<!DOCTYPE HTML>

[%settitle RESTful API%]
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
[%file newheader%]
</head>
<body>
[%file newnavbar%]



<h2>RESTful API</h2>
<table class="colsn"><tr><td id="wg"><a _target="blank" href="[%wg fhir%]">[%wgt fhir%]</a> Work Group</td><td id="fmm"><a href="versions.html#maturity">Maturity Level</a>: Normative</td><td id="ballot"><a href="versions.html#std-process">Standards Status</a>:<!--!ns!--><a href="versions.html#std-process">Normative</a></td></tr></table>

[%normative page infrastructure%]

<p>
FHIR is described as a 'RESTful' specification based on common industry level use of the term REST. In practice, FHIR only supports Level 2 of the
<a href="https://martinfowler.com/articles/richardsonMaturityModel.html">REST Maturity model</a> as part of the core specification, though full Level 3
conformance is possible through the use of <a href="extensibility.html">extensions</a>. Because FHIR is a standard, it relies on the standardization of
resource structures and interfaces.  This may be considered a violation of REST principles but is key to ensuring consistent interoperability across
diverse systems.
</p>
<p>
Each "resource type" has the same set of interactions defined that can be used to manage the resources
in a highly granular fashion. Applications claiming conformance to this framework
claim to be conformant to "RESTful FHIR"  (see <a href="conformance-rules.html">Conformance</a>).
</p>
<p>
Note that in this RESTful framework, transactions are performed directly on the server resource using an
HTTP request/response. The API does not directly address authentication, authorization, and audit
collection - for further information, see the <a href="security.html">Security Page</a>. All the
interactions are all described for synchronous use, and an <a href="async.html">Asynchronous use
pattern</a> is also defined.
</p>
<p>
The API describes the FHIR resources as a set of operations (known as "interactions") on resources where
individual resource instances are managed in collections by their type. Servers can choose which of
these interactions are made available and which resource types they support. Servers SHALL
provide a <a href="capabilitystatement.html">Capability Statement</a> that specifies which interactions and
resources are supported.
</p>
<p>
In addition to a number of <a href="#general">General Considerations</a> this page defines the following interactions:
</p>
<a name="interactions"></a>
<a name="operations"></a>
<table class="list">
  <tr><td><b>Instance Level Interactions</b></td><td></td></tr>
  <tr><td><a href="#read">read</a></td><td>Read the current state of the resource</td></tr>
  <tr><td><a href="#vread">vread</a></td><td>Read the state of a specific version of the resource</td></tr>
  <tr><td><a href="#update">update</a></td><td>Update an existing resource by its id (or create it if it is new)</td></tr>
  <tr><td><a href="#patch">patch</a></td><td>Update an existing resource by posting a set of changes to it</td></tr>
  <tr><td><a href="#delete">delete</a></td><td>Delete a resource</td></tr>
  <tr><td><a href="#history">history</a></td><td>Retrieve the change history for a particular resource</td></tr>
  <tr><td colspan="2"><b>Type Level Interactions</b></td></tr>
  <tr><td><a href="#create">create</a></td><td>Create a new resource with a server assigned id</td></tr>
  <tr><td><a href="#search">search</a></td><td>Search the resource type based on some filter criteria</td></tr>
  <tr><td><a href="#cdelete">delete</a></td><td>Conditional Delete across a particular resource type based on some filter criteria</td></tr>
  <tr><td><a href="#history">history</a></td><td>Retrieve the change history for a particular resource type</td></tr>
  <tr><td colspan="2"><b>Whole System Interactions</b></td></tr>
  <tr><td><a href="#capabilities">capabilities</a></td><td>Get a capability statement for the system</td></tr>
  <tr><td><a href="#transaction">batch/transaction</a></td><td>Perform multiple operations (e.g. create, read, update, delete, patch, and/or [extended operations]) in a single interaction</td></tr>
  <tr><td><a href="#cdelete">delete</a></td><td>Conditional Delete across all resource types based on some filter criteria</td></tr>
  <tr><td><a href="#history">history</a></td><td>Retrieve the change history for all resources</td></tr>
  <tr><td><a href="#search">search</a></td><td>Search across all resource types based on some filter criteria</td></tr>
</table>
<p>
In addition to these interactions, there is an <a href="operations.html">operations framework</a>, which includes endpoints
for <a href="operation-resource-validate.html">validation</a>, <a href="messaging.html#mailbox">messaging</a> and <a href="documents.html#bundle">Documents</a>.
Also, implementers can <a href="graphql.html">use GraphQL</a>.</p>

<a name="general"></a>
<h3>General Considerations</h3>

<p>
Note: Where the FHIR specification does not specify behavior with regards to HTTP
capabilities (such as OPTIONS), implementers cannot expect greater consistency
than is mandated in the underlying HTTP protocol.
</p>

<a name="styleguide"></a>
<h4>Style Guide</h4>
<p>
The interactions on this page are defined like this:
</p>

<pre>
  VERB [base]/[type]/[id] {?_format=[mime-type]}
</pre>
<ul>
 <li>The first word is the HTTP verb used for the interaction</li>
 <li>Content surrounded by [] is mandatory, and will be replaced by the string literal identified. Possible insertion values:
   <ul>
     <li><code>base</code>: The <a href="#root">Service Base URL</a></li>
     <li><code>mime-type</code>: The <a href="#mime-type">Mime Type</a></li>
     <li><code>type</code>: The name of a resource type (e.g. "Patient")</li>
     <li><code>id</code>: The <a href="resource.html#id">Logical Id</a> of a resource</li>
     <li><code>vid</code>: The <a href="resource.html#metadata">Version Id</a> of a resource</li>
     <li><code>compartment</code>: The name of a <a href="compartmentdefinition.html">compartment</a></li>
     <li><code>parameters</code>: URL parameters as defined for the particular interaction</li>
   </ul>
 </li>
 <li>Content surrounded by <code>{}</code> is optional</li>
</ul>
<p>
Implementations constructing URLs using these patterns SHOULD conform to <a href="https://tools.ietf.org/html/rfc3986#appendix-A">RFC 3986 Section 6 Appendix A</a>
which requires percent-encoding for a number of characters that occasionally appear in the URLs (mainly in search parameters).
</p>
<p>
This specification uses the underscore as a prefix to disambiguate reserved names from other names in 3 cases:
</p>
<ul>
 <li>To differentiate system wide history and search interactions from interactions on Resource Types</li>
 <li>To differentiate search, history and similar interactions from instances of a resource type</li>
 <li>To differentiate search parameters defined for all resources from those defined for specific resource types</li>
</ul>
<p>
In addition, the character <code>$</code> is used as a prefix to operation names that are RPC-like additions to the base
API defined either by this specification or by implementers.
</p>

<a name="root"></a>
<a name="general"></a>
<h4>Service Base URL</h4>
<p>
The Service Base URL is the address where all of the
resources defined by this interface are found. The Service
Base URL takes the form of
</p>
<pre>
http{s}://server{/path}
</pre>
<p>
The path portion is optional, and does not include a trailing slash. Each
resource type defined in this specification has a manager (or "entity set")
that lives at the address <code>/[type]</code> where the
<code>[type]</code> is the name of the resource type.
For instance, the resource manager for the type
<code>Patient</code> will live at:
</p>
<pre>
https://server/path/Patient
</pre>
<p>
All the logical interactions are defined relative to the service root
URL. This means that if the address of any one FHIR resource on a system
is known, the address of other resources may be determined.
</p>
<p>
Note: All URLs (and ids that form part of the URL) defined by this specification are case sensitive.
Clients SHOULD encode URLs using UTF-8, and servers SHOULD decode them assuming they are UTF-8
(for background, <a href="http://stackoverflow.com/questions/912811/what-is-the-proper-way-to-url-encode-unicode-characters">see here</a>).
</p>
<p>
Note that a server may use a path of the form <code>http://server/...[xx]...</code> where the <code>[xx]</code> is some variable
portion that identifies a particular instantiation of the FHIR API. Typically, the variable id
identifies a patient or a user, and the underlying information is completely compartmented
by the logical identity associated with <code>[xx]</code>. In this case, the FHIR API presents a
patient or user centric view of a record, where authentication/authorization is
explicitly granted to the URL, on the grounds that some identifiable user is associated
with the logical identity. It is not necessary to explicitly embed the patient id in the
URL - implementations can associate a FHIR end-point with a particular patient or
provider by using an OAuth login. See <a href="compartmentdefinition.html">Compartments</a> for the logical underpinning.
</p>
<p>
Servers SHALL support both forms (with a trailing slash ex:<code>[base]/[type]/</code>, and without a trailing slash ex:<code>[base]/type]</code> ) if they support either,
and servers are discouraged from redirecting a client to achieve a canonical query URL.
It is up to a server to decide whether to "canonicalize" a query (e.g., when populating Bundle.link[self],
a server can add or remove a trailing slash to fit its own preferred convention).
</p>
<p><b>Identity</b></p>
<p>
Systems often need to compare two URLs to determine whether they refer to the same underlying object or not.
For the purposes of this specification, the following rules apply:
</p>
<ul>
 <li>The query part of the URL (anything after <code>?</code>) is ignored</li>
 <li>The comparison of the document portion of the URL (i.e. not the server:port) is case sensitive</li>
 <li>The protocols <code>http:</code> and <code>https:</code> SHALL NOT be used to refer to different underlying objects</li>
 <li>If a port is specified, then the ports must be identical or the objects are different (due to
   the prevalence of port mapping and/or interface engines running on different ports). Ports should
	 only be explicit when they have explicit meaning to the server</li>
</ul>
<p>
For example:
<code>http://myserver.com/Patient/1</code> and <code>https://myserver.com/Patient/1</code> refer to the same underlying object, while <code>http://myserver.com:81/Patient/1</code> is a distinct entity from either of the above.
This does not mean that the two addresses need to be treated the same, or that a server must serve both addresses, or that the content from the two addresses must be identical, but just that if these two
addresses have the same identity, and if both are served, they must both represent the same underlying object. Systems are not required to
check that this is true. Note: the identity comparison for protocols other than http:/https: is undefined.
</p>

<a name="versioning"></a>
<h4>Resource Metadata and Versioning</h4>
<p>
Each resource has an associated set of <a href="resource.html#metadata">resource metadata elements</a>. These map to the HTTP request and response using the following fields:
</p>
<table class="grid">
  <tr><th>Metadata Item</th><th>Where found in HTTP</th></tr>
  <tr><td><a href="resource.html#id">Logical Id (.id)</a></td><td>The Id is represented explicitly in the URL</td></tr>
  <tr><td><a href="resource.html#metadata">Version Id (.meta.versionId)</a></td><td>The Version Id is represented in the <code>ETag</code> header</td></tr>
  <tr><td><a href="resource.html#metadata">Last modified (.meta.lastUpdated)</a></td><td>HTTP Last-Modified header</td></tr>
</table>
<p>
Notes:
</p>
<ul>
 <li>The <code>Last-Modified</code> header should come from <code><a href="resource-definitions.html#Meta.lastUpdated">.meta.lastUpdated</a></code> which is a FHIR <code><a href="datatypes.html#instant">instant</a></code>, but the <code>Last-Modified</code> header has a different format. See <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Last-Modified">Last-Modified</a> and <a href="https://tools.ietf.org/html/rfc7232#section-2.2">rfc7232#section-2.2</a></li>
 <li>The Version Id is considered a "weak" ETag and <code>ETag</code> headers should be prefixed with <code>W/</code> and enclosed in quotes, for example:</li>
</ul>
<pre>
ETag: W/"3141"
</pre>
<h4>Security</h4>
<p>
Using HTTPS is optional, but all production exchange of healthcare data SHOULD use SSL and
additional security as appropriate. See <a href="security.html#http">HTTP Security</a> for further information.
Most operations will require user authentication, and all operations that do so are subject
to <a href="https://en.wikipedia.org/wiki/Role-based_access_control">RBAC</a> and/or <a href="https://en.wikipedia.org/wiki/Attribute-based_access_control">ABAC</a>,
and some operations may depend on appropriate consent being granted.
</p>
<p>
Note: to support browser-based client applications, servers SHOULD implement <a href="http://enable-cors.org/">cross-origin resource sharing (CORS)</a> for the interactions documented here.
</p>
<p>
See the <a href="security.html#AccessDenied">HTTP Security</a> guidance for further information about both security generally and the use of CORS.
</p>

<a name="Status-Codes"></a>
<h4>HTTP Status Codes</h4>
<p>
This specification makes rules about the use of specific HTTP status codes
in particular circumstances where the status codes SHALL map to particular
states correctly, and only where the correct status code is not obvious.
Other HTTP status codes may be used for other states as appropriate, and this particularly
includes various authentication related status codes and redirects.
Authentication redirects should not be interpreted to change the location
of the resource itself (a common web programming error).
</p>
<p>
FHIR defines an <a href="operationoutcome.html">OperationOutcome resource</a> that can be used to convey specific detailed
processable error information. For some combinations of interactions and specific
return codes, an OperationOutcome is required to be returned as the content of the response.
The OperationOutcome may be returned with any HTTP <code>4xx</code> or <code>5xx</code> response, but this is not required - many of
these errors may be generated by generic server frameworks underlying a FHIR server.
</p>

<a name="Http-Headers"></a>
<h4>HTTP Headers</h4>
<p>
  This specification makes use of several HTTP headers to change the processing
  or format of requests or results.
</p>

<table class="grid">
  <tr>
    <td><b>Tag</b></td>
    <td><b>Direction</b></td>
    <td><b>MDN</b></td>
    <td><b>RFC</b></td>
    <td><b>Notes</b></td>
  </tr>

  <tr>
    <td><code>Accept</code></td>
    <td><code>request</code></td>
    <td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept">Accept</a></td>
    <td><a href="https://www.rfc-editor.org/rfc/rfc7231#section-5.3.2">RFC-7231 §5.3.2</a></td>
    <td>
      Content-negotiation for MIME Type and FHIR Version, see:
      <a href="#mime-type">Content Types and Encodings</a>, 
      <a href="#version-parameter">FHIR Version Parameter</a>, and
      <a href="#parameters">General Parameters</a> (_format).</td>
  </tr>

  <tr>
    <td><code>ETag</code></td>
    <td><code>response</code></td>
    <td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/ETag">ETag</a></td>
    <td><a href="https://www.rfc-editor.org/rfc/rfc7232#section-2.3">RFC-7232 §2.3</a></td>
    <td>The value from <code>.meta.versionId</code> as a "weak" ETag, prefixed with <code>W/</code> and enclosed in quotes (e.g., <code>W/"3141"</code>).</td>
  </tr>

  <tr>
    <td><code>If-Match</code></td>
    <td><code>request</code></td>
    <td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-Match">If-Match</a></td>
    <td><a href="https://www.rfc-editor.org/rfc/rfc7232#section-3.1">RFC-7232 §3.1</a></td>
    <td>
      ETag-based matching for conditional requests, see: 
      <a href="#cread">Conditional Read</a>, 
      <a href="#cond-update">Conditional Update</a>,
      <a href="#cond-patch">Conditional Patch</a>,
      <a href="#concurrency">Managing Resource Contention</a>, and
      <a href="#versions">Support for Versions</a>.</td>
  </tr>

  <tr>
    <td><code>If-Modified-Since</code></td>
    <td><code>request</code></td>
    <td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-Modified-Since">If-Modified-Since</a></td>
    <td><a href="https://www.rfc-editor.org/rfc/rfc7232#section-3.3">RFC-7232 §3.3</a></td>
    <td>Date-based matching for conditional read requests, see: <a href="#cread">Conditional Read</a>.</td>
  </tr>

  <tr>
    <td><code>If-None-Exist</code></td>
    <td><code>request</code></td>
    <td>-</td>
    <td>-</td>
    <td>
      HL7 defined extension header to prevent the creation of duplicate resources, see:
      <a href="#ccreate">Conditional Create</a>.
    </td>
  </tr>

  <tr>
    <td><code>If-None-Match</code></td>
    <td><code>request</code></td>
    <td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-None-Match">If-None-Match</a></td>
    <td><a href="https://www.rfc-editor.org/rfc/rfc7232#section-3.2">RFC-7232 §3.2</a></td>
    <td>ETag-based matching for conditional requests, see: <a href="#cread">Conditional Read</a> and <a href="#cond-update">Conditional Update</a>.</td>
  </tr>

  <tr>
    <td><code>Last-Modified</code></td>
    <td><code>response</code></td>
    <td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Last-Modified">Last-Modified</a></td>
    <td><a href="https://www.rfc-editor.org/rfc/rfc7232#section-2.2">RFC-7232 §2.2</a></td>
    <td>The value from <code>.meta.lastUpdated</code>, which is a FHIR instant, converted to the proper format.</td>
  </tr>

  <tr>
    <td><code>Prefer</code></td>
    <td><code>request</code></td>
    <td>-</td>
    <td><a href="https://www.rfc-editor.org/rfc/rfc7240">RFC-7240</a></td>
    <td>
      Request various behaviors specific to a single request, see:
      <a href="#ops">create/update/patch/transaction</a> (<a href="https://www.rfc-editor.org/rfc/rfc7240#section-4.2">Return preference</a>),
      <a href="search.html#errors">Search: Handling Errors</a> (<a href="https://www.rfc-editor.org/rfc/rfc7240#section-4.4">Processing preference (strict, lenient)</a>), and
      <a href="async.html">Async Request Patterns</a> (<a href="https://www.rfc-editor.org/rfc/rfc7240#section-4.1">Respond-async preference</a>).
    </td>
  </tr>

  <tr>
    <td><code>Location</code></td>
    <td><code>response</code></td>
    <td>-</td>
    <td><a href="https://www.rfc-editor.org/rfc/rfc7231#section-7.1.2">RFC-7231 §37.1.2</a></td>
    <td>
      Used in the response to a create and an upsert to indicate where the resource can be found after being processed.
    </td>
  </tr>
  
  <tr>
    <td><code>Content-Location</code></td>
    <td><code>response</code></td>
    <td>-</td>
    <td><a href="https://www.rfc-editor.org/rfc/rfc7231#section-3.1.4.2">RFC-7231 §3.1.4.2</a></td>
    <td>
      Used in the <a href="async.html">Async pattern</a> to indicate where the response to the request can be found. 
    </td>
  </tr>
 </table>

<p>
See also the <a href="#custom">Custom Headers</a> table.
</p>

<a name="return"></a>
<h4>Managing Return Content</h4>
<p>
If the server has a default timezone, it SHOULD return the default timezone in the HTTP Response headers using the "<code>Date</code>" header.
</p>
<p>
In the interests of managing band-width, this specification allows clients
to specify what kind of content to return for resources.
</p>

<a name="cread"></a>
<h4>conditional read</h4>
<p>
Clients may use the <code>If-Modified-Since</code>, or <code>If-None-Match</code> HTTP header on a <code>read</code> request.
If so, they SHALL accept either a <code>304 Not Modified</code> as a valid status code on the response (which means that the
content is unchanged since that date) or full content (either the content has changed,
or the server does not support conditional request).
</p>
<p>
Servers can return <code>304 Not Modified</code> where content is unchanged because the
<code>If-Modified-Since</code> date-time or the <code>If-None-Match</code> ETag was specified, or they can
return the full content as normal. This optimisation is relevant in reducing bandwidth for caching purposes and servers are encouraged but
not required to support this. If servers don't support conditional read, they just return the full content.
</p>

<a name="ops"></a>
<h4>create/update/patch/transaction</h4>
<p>
These interactions are performed using <code>POST</code>, <code>PUT</code> or <code>PATCH</code>, and
it may be appropriate for a server to return either only a status
code, or also return the entire resource that is the outcome of the
create or update (which may be different to that provided by the
client). In the case of transactions this means returning a Bundle with just the <code>Bundle.entry.response</code> populated for each entry,
and not the <code>Bundle.entry.resource</code> values.
</p>
<a name="prefer"></a>
<p>The client can indicate whether the entire resource is
returned using the <a href="https://tools.ietf.org/html/rfc7240#section-4.2">HTTP
return preference</a>:
</p>
<pre>
Prefer: return=minimal
Prefer: return=representation
Prefer: return=OperationOutcome
</pre>
<p>
The first of these asks to return no body. The
second asks to return the full resource. The third asks
the server to return an <a href="operationoutcome.html">OperationOutcome</a>
resource containing hints and warnings about the operation rather than the
full resource. Servers SHOULD honor this header. In the absence of the header,
servers may choose whether to return the full resource or not (but not the OperationOutcome;
that should only be returned if explicitly requested). Note that this setting
only applies to successful interactions. In case of failure, servers SHOULD
always return a body that contains an <a href="operationoutcome.html">OperationOutcome</a> resource.
</p>
<p>
See also the <a href="async.html">Asynchronous use pattern</a> for another use of
the <code>Prefer</code> header.
</p>

<a name="mime-type"></a>
<h4>Content Types and encodings</h4>
<p>
The formal MIME-type for FHIR resources is <code>application/fhir+xml</code> or <code>application/fhir+json</code>.
The correct mime type SHALL be used by clients and servers:
</p>
<ul>
 <li>XML: <code>application/fhir+xml</code></li>
 <li>JSON: <code>application/fhir+json</code></li>
 <li>RDF: <code>application/fhir+turtle</code> (only the Turtle format is supported)</li>
</ul>
<p>
Servers SHALL support server-driven content negotiation as described in <a href="https://tools.ietf.org/html/rfc7231#section-3.4">section 3.4</a>
of the HTTP specification.
</p>
<p>
Implementation Notes:
</p>
<ul>
<li>The content type <code>application/x-www-form-urlencoded</code> (<a href="https://url.spec.whatwg.org/#application/x-www-form-urlencoded">Specification</a>) is also accepted for posting <code>search</code> requests.</li>
<li>
If a client provides a generic mime type in the Accept header
(application/xml, text/json, or application/json), the server SHOULD respond with
the requested mime type, using the XML or JSON formats described in this specification
as the best representation for the named mime type (except for binary - see the <a href="binary.html#rest">note on the
Binary resource</a>).
</li>
<li>
Note: between FHIR DSTU2 and STU3, the correct mime type was changed from <code>application/xml+fhir</code> and <code>application/json+fhir</code> to <code>application/fhir+xml</code> and <code>application/fhir+json</code>.
Servers MAY also support the older mime types, and are encouraged to do so to smooth the transition process.
</li>
<li>
<code>406 Not Acceptable</code>  is the appropriate response when the <code>Accept</code> header requests a format that the server
does not support, and <code>415 Unsupported Media Type</code> when the client posts a format that is not supported
to the server.
</li>
</ul>
<p>
UTF-8 encoding SHALL be used for FHIR instances. This MAY be specified as a MIME type parameter, but is not required.
</p>
<a name="version-parameter"> </a>
<h4>FHIR Version Parameter</h4>
<p>
This specification defines the MIME-type parameter <code>fhirVersion</code> as a parameter to indicate
which version of the FHIR release a resource is based on:
</p>
<pre>
  Accept: application/fhir+json; fhirVersion=4.0
</pre>
<p>
The value of this parameter is the <a href="versions.html#versions">major and minor version number</a>
for the specification:
</p>
<table class="grid">
<tr>
<td><a href="http://hl7.org/fhir/DSTU1">FHIR R1</a> (DSTU 1)</td>
<td>0.0</td>
</tr>
<tr>
<td><a href="http://hl7.org/fhir/DSTU2">FHIR R2</a> (DSTU 2)</td>
<td>1.0</td>
</tr>
<tr>
<td><a href="http://hl7.org/fhir/STU3">FHIR R3</a> (STU3, or just R3)</td>
<td>3.0</td>
</tr>
<tr>
  <td><a href="http://hl7.org/fhir/r4">FHIR R4</a> (R4, mixed STU/Normative)</td>
  <td>4.0</td>
</tr>
<tr>
  <td><a href="http://hl7.org/fhir/r4b">FHIR R4B</a> (R4B, only STU changes)</td>
  <td>4.3 (once published)</td>
</tr>
<tr>
  <td><a href="http://hl7.org/fhir/r5">FHIR R5</a> (this version)</td>
  <td>5.0 (once published)</td>
</tr>
</table>
<p>Intermediate balloted releases may also be encountered occasionally - see <a href="http://hl7.org/fhir/directory.html">publications directory</a>.
Versions from before the publication of the <a href="http://hl7.org/fhir/DSTU1/index.html">first DSTU</a> (which is 0.0) are not supported.
</p>
<p>
This parameter can be used anywhere that the FHIR Mime type is used. When used in an HTTP request, the
version parameter may be used on either the Content-Type header, or the Accept header, or both, and
applies to the entire interaction (the behavior of the interactions as described on ths page, the
search parameters and functionality, and the accompanying conformance resources). It is an error for
the Accept header to specify a different version than the Content-Type header unless invoking an operation
that is specifically defined to perform version conversion (e.g. <code><a href="resource-operation-convert.html">$convert</a></code>.
For further information about specifying FHIR version, see <a href="versioning.html">Managing FHIR Versions</a>.
</p>

<a name="mime-type"></a>
<a name="parameters"></a>
<h4>General parameters</h4>

<p>
The following parameters are defined for use with all of the interactions defined on this page:
</p>
<table class="grid">
 <tr> <td><code>_format</code></td> <td>Override the HTTP content negotiation - see immediately below</td> </tr>
 <tr> <td><code>_pretty</code></td> <td>Ask for a pretty printed response for human convenience - see below</td> </tr>
 <tr> <td><code>_summary</code></td> <td>Ask for a predefined short form of the resource in response - see <a href="search.html#summary">Search Summary</a></td> </tr>
 <tr> <td><code>_elements</code></td> <td>Ask for a particular set of elements to be returned - see <a href="search.html#elements">Search Elements</a></td> </tr>
</table>

<p><b>_format</b></p>
<p>
In order to support various implementation limitations, servers SHOULD support the optional <code>_format</code> parameter to
specify alternative response formats by their MIME-types. This parameter allows a client to override the <code>accept</code>
header value when it is unable to set it correctly due to internal limitations (e.g. XSLT usage). For the <code>_format</code>
parameter, the values <code>xml</code>, <code>text/xml</code>, <code>application/xml</code>, and <code>application/fhir+xml</code>
SHALL be interpreted to mean the <a href="xml.html">XML format</a>, the codes <code>json</code>, <code>application/json</code> and
<code>application/fhir+json</code> SHALL be interpreted to mean the <a href="json.html">JSON format</a>, and the codes <code>ttl</code>,
<code>application/fhir+turtle</code>, and <code>text/turtle</code> SHALL be interpreted to mean the <a href="rdf.html">Turtle RDF format</a>. In addition, the values
<code>html</code> and <code>text/html</code> are allowed.
</p>
<p>
  Implementation Notes:
</p>
<ul>
  <li>If a client provides a generic mime type in the Accept header (application/xml, text/json, or application/json),
    the server SHOULD respond with the requested mime type, using the <a href="xml.html">XML</a> or <a href="json.html">JSON</a>
    formats described in this specification as the best representation for the named mime type 
    (though see the note on the <a href="binary.html#rest">Binary resource</a>).</li>
<li>the <code>_format</code> parameter does not override the <code>Content-Type</code> header for the
type of the body of a POST request. If neither the accept header nor the _format parameter are specified, the MIME-type
of the content returned by the server is undefined and may vary</li>
</ul>

<p><b>_pretty</b></p>
<p>
Clients that wish to request for pretty-printed resources (either in JSON or XML) can
use the _pretty parameter:
</p>
<pre>
GET [base]/Patient/example?_pretty=true
</pre>
<p>
Value values are <code>true</code> and <code>false</code>. Since pretty printed
or not makes no difference to the content, this is only of interest for development
tools, and servers MAY choose to support this parameter.
</p>
<p><b>_summary</b></p>
<p>
Indicates that the resource(s) in the response should only include the identified categoric subset of elements. See <code><a href="search.html#summary">Search Summary</a></code> for details.
</p>
<p><b>_elements</b></p>
<p>
Indicates that the resource(s) in the response should only include the enumerated elements (plus any mandatory or modifier elements). See <code><a href="search.html#elements">Search Elements</a></code> for details.
</p>

<a name="versions"></a>
<h4>Support for Versions</h4>
<p>
Servers that support this API SHOULD provide full version support - that is, populate and track
<code>versionId</code> correctly, support <code>vread</code>, and implement <a href="#versionaware">version aware updates</a>.
Supporting versions like this allows for related systems to track the correct version of information,
and to keep integrity in clinical records. However, many current operational systems do not
do this, and cannot easily be re-engineered to do so.
</p>
<p>
For this reason, servers are allowed to not provide versioning support and this API does not enforce
that versioning is supported. Clients may elect to only interact with servers that do provide full
versioning support. Systems declare their support for versioning
in their <a href="capabilitystatement-definitions.html#CapabilityStatement.rest.resource.versioning">Capability Statements</a>,
where they can indicate one of three levels for versioning support:
</p>
<ul>
 <li><b>no-version</b>: Versioning and <code>meta.version</code> is not supported (server) or used (client)</li>
 <li><b>versioned</b>: Versioning and <code>meta.version</code> is supported (server) or used (client)</li>
 <li><b>versioned-update</b>:	Versioning and <code>meta.version</code> is supported, and version aware updates are used - supports version-aware updates (server) or will be specified (If-match header) for updates (client)</li>
</ul>
<p>
Servers that do not support versioning SHALL ensure that <code>Resource.meta.versionId</code> is not present on
resources they return, and SHALL update the value of <code>Resource.meta.lastUpdated</code> correctly.
</p>

<a name="timezones"></a>
<h4>Client Timezone</h4>
<p>
In general, it is the business of the client to know which timezone a user is in, and update the 
date/times accordingly. Note that not all date times should be adjusted to local time - particularly
past dates in the clinical record, which generally should be reported in their timezone of origin (e.g. the patient 
was admitted at 2pm in their local timezone). 
</p>
<p>
However when the server is executing logic on behalf of the client, particularly for various operations, it
may be important for the server to know what timezone the request is made on behalf of. In such cases, 
the client timezone may be communiciated to the server using the <code>client-timezone</code> header 
defined in this <a href="https://tools.ietf.org/html/draft-sharhalakis-httptz-05">RFC</a> (note that this 
RFC was not adopted by the community). 
</p>
<p>
Because the client does not know when the server is executing logic on behalf of the user, 
clients SHOULD always populate this header, and servers SHOULD use this header to determine
the user's timezone.
</p>

<a name="read"></a>
<h3>read</h3>
<p>
The <code>read</code> interaction accesses the current contents of a resource. The interaction
is performed by an HTTP <code>GET</code> command as shown:
</p>
<pre class="http">
  GET [base]/[type]/[id] {?_format=[mime-type]}
</pre>
<p>
This returns a single instance with the content specified for the resource type.
This url may be accessed by a browser. The possible values for the
<a href="resource.html#id">Logical Id</a> ("id") itself are described in the <a href="datatypes.html#id">id type</a>.
The returned resource SHALL have an <code>id</code> element with a value that is the <code>[id]</code>.
Servers SHOULD return an <code>ETag</code> header with the versionId of the resource (if versioning is supported) and a <code>Last-Modified</code> header.
</p>
<p>
Note: Unknown resources and deleted resources are treated differently on a read: a <code>GET</code> for a deleted
resource returns a <code>410 Gone</code> status code (see the <a href="#delete">delete</a> interaction for addition details),
whereas a <code>GET</code> for an unknown resource returns <code>404 Not Found</code>. Systems that do
not track deleted records will treat deleted records as an unknown resource. Since deleted resources may be brought
back to life, servers MAY include an ETag on the error response when reading a deleted record to allow version
contention management when a resource is brought back to life.
</p>

<p>
In addition, the search parameter <code>_summary</code> can be used when reading a resource:
</p>
<pre class="http">
  GET [base]/[type]/[id] {?_summary=text}
</pre>
<p>
This requests that only a subset of the resource content be returned,
as specified in the <code>_summary</code> parameter, which can have the values
<a href="search.html#summary"><code>true</code>, <code>false</code>, <code>text</code>, <code>count</code> and <code>data</code></a>.
Note that a resource that only contains a subset of the data is
not suitable for use as a base to update the resource, and might not
be suitable for other uses. The same applies to the <a href="search.html#elements">_elements</a> parameter - both
that it should be supported, and the subset implications. Servers SHOULD define a <code>Resource.meta.tag</code> with
the <a href="https://terminology.hl7.org/CodeSystem-v3-ObservationValue.html#v3-ObservationValue-SUBSETTED">SUBSETTED</a> as a <a href="resource.html#simple-tags">Simple Tag</a>
to explicitly mark such resources.
</p>
<p>
A HEAD request can also be used - <a href="#head">see below</a>.
</p>

<a name="vread"></a>
<h3>vread</h3>
<p>
The <code>vread</code> interaction performs a version specific read of the resource. The interaction
is performed by an HTTP <code>GET</code> command as shown:
</p>
<pre>
  GET [base]/[type]/[id]/_history/[vid] {?_format=[mime-type]}
</pre>
<p>
This returns a single instance with the content specified for the resource type for that
version of the resource.
The returned resource SHALL have an <code>id</code> element with a value that is the <code>[id]</code>, and a <code>meta.versionId</code>
element with a value of <code>[vid]</code>. Servers SHOULD return an <code>ETag</code> header with the versionId (if versioning is supported)
and a <code>Last-Modified</code> header.
</p>
<p>
The <a href="resource.html#metadata">Version Id</a> ("vid") is an opaque identifier that conforms to the same <a href="datatypes.html#id">format requirements</a> as
a <a href="resource.html#id">Logical Id</a>. The id may have been found by performing a history interaction (see below), by recording the
version id from a content location returned from a <code>read</code> or from a version specific reference in a
content model. If the version referred to is actually one where the resource was deleted, the
server should return a <code>410 Gone</code> status code (see the <a href="#delete">delete</a> interaction for addition details).
</p>
<p>
Servers are encouraged to support a version specific retrieval of the current version of the
resource even if they do not provide access to previous versions. If a request
is made for a previous version of a resource, and the server does not support accessing
previous versions (either generally, or for this particular resource), it should
return a <code>404 Not Found</code> error, with an operation outcome explaining that
history is not supported for the underlying resource type or instance.
</p>
<p>
A HEAD request can also be used - <a href="#head">see below</a>.
</p>

<a name="update"></a>
<h3>update</h3>
<p>
The <code>update</code> interaction creates a new current version for an existing resource or
creates an initial version if no resource already exists for the given id.
The <code>update</code> interaction is performed by an HTTP <code>PUT</code> command as shown:
</p>
<pre class="http">
  PUT [base]/[type]/[id] {?_format=[mime-type]}
</pre>
<p>
The request body SHALL be a <a href="resource.html">Resource</a> of the named type with an <code>id</code> element
that has an identical value to the <code>[id]</code> in the URL. If no <code>id</code> element is provided,
or the id disagrees with the id in the URL, the server SHALL respond with an HTTP <code>400 Bad Request</code> error code, and SHOULD
provide an <a href="operationoutcome.html">OperationOutcome</a> identifying the issue.
If the request body includes a <a href="resource.html#meta"><code>meta</code></a>, the server SHALL
ignore the provided <code>versionId</code> and <code>lastUpdated</code> values.

If the server supports versions, it SHALL populate the <code>meta.versionId</code> and <code>meta.lastUpdated</code>
with the new correct values. Servers are allowed to review and alter the other metadata values, but SHOULD refrain
from doing so (see <a href="resource.html#meta">metadata description</a> for further information). Note that
there is no support for updating past versions - see notes on the <a href="#history">history</a> interaction.
</p>
<p>
A server SHOULD accept the resource as submitted when it accepts the update, and return the same
content when it is subsequently read. However systems might not be able to do this; see
the note on <a href="#transactional-integrity">transactional integrity</a> for discussion.
Also, see <a href="updates.html">Variations between Submitted data and Retrieved data</a> for additional discussion
around update behavior. Note that <code>update</code> generally updates the whole content of the resource. For partial
updates, see <a href="#patch"><code>patch</code></a> below.
</p>
<p>
If the interaction is successful and the resource was updated, the server SHALL return a <code>200 OK</code> HTTP status code.
If the interaction is successful and the resource was created, the server SHALL return a <code>201 Created</code> HTTP status code.
The server SHALL also return a <code>Location</code> header which
contains the new <a href="resource.html#metadata">Logical Id</a> and <a href="resource.html#metadata">Version Id</a> of
the created resource version:
</p>
<pre class="http">
  Location: [base]/[type]/[id]/_history/[vid]
</pre>
<p>
where <code>[id]</code> and <code>[vid]</code> are the existing or newly created id and version id for the resource version.
The Location header should be as specific as possible - if the server understands versioning, the version is
included. If a server does not track versions, the Location header will just contain [base]/[type]/[id]. The
Location MAY be an absolute or relative URL.
</p>
<p>
Servers SHOULD return an <code>ETag</code> header with the <code>versionId</code> (if versioning is supported) and a <code>Last-Modified</code> header.
</p>
<p>
The body of the response is as described in <a href="http.html#return">Managing Return Content</a>.
</p>
<p>
Note: Servers MAY choose to preserve XML comments, instructions, and formatting or JSON whitespace when accepting updates, but are not required to do so. The impact of this on digital signatures may need to be considered.
</p>
<p>
Note: It is possible that a client may attempt to update a resource that was obtained using search and that was marked with the <code>SUBSETTED</code> tag. It is at the server's discretion whether to accept requests that are tagged as <code>SUBSETTED</code> and, if so, how to handle them.
</p>
<div class="draft-content">
<p>
Servers that determine that a POST would result in a duplicate MAY return a <code>303 See Other</code> pointing to the existing (unchanged) record 
and indicating that the record was not created because the specified resource already exists at the specified location.
</p>
</div>

<a name="upsert"></a>
<h4>Update as Create</h4>
<p>
Servers MAY choose to allow clients to <code>PUT</code> a resource to a location that
does not yet exist on the server - effectively, allowing the client to define the
id of the resource. Whether a server allows this is a deployment choice based
on the nature of its relationships with the clients. While many servers will
not allow clients to define their ids, there are several reasons why it may
be necessary in some configurations:
</p>
<ul>
 <li>client is reproducing an existing data model on the server, and needs to keep original ids in order to retain ongoing integrity</li>
 <li>client is a server doing push based pub/sub (this is a special case of the first reason)</li>
 <li>multiple clients doing push in the context of agreed data model shared across multiple servers where ids are shared across servers</li>
</ul>
<p>
Alternatively, clients may be sharing an agreed identification model (e.g. key server, scoped identifiers, or UUIDs)
where clashes do not arise. Note that this use of <code>update</code> has <a href="security.html#AccessDenied">security implications</a>.
</p>
<p>
Servers can choose whether or not to support client defined ids, and indicate such to the clients
using <a href="capabilitystatement-definitions.html#CapabilityStatement.rest.resource.updateCreate">CapabilityStatement.rest.resource.updateCreate</a>.
</p>
<p>
A server SHALL not return a <code>201</code> response if it did not create a new resource.
If a new resource is created, a location header SHALL be returned (though it SHALL be the 
same as the location in the URL of the PUT request).
</p>

<a name="rejecting-updates"> </a>
<h4>Rejecting Updates</h4>
<p>
Servers are permitted to reject update interactions because of integrity concerns or other business rules, and return HTTP status codes accordingly (usually a <code>422 Unprocessable Entity</code>).
Note that there are potential security issues relating to how rejections are handled. See the <a href="security.html#AccessDenied">security page</a> for more information.
</p>
<p>
Common HTTP Status codes returned on FHIR-related errors (in addition to normal HTTP errors related to security, header and content type negotiation issues):
</p>
<ul>
 <li><b><code>400 Bad Request</code></b> - resource could not be parsed or failed basic FHIR validation rules (or multiple matches were found for conditional criteria)</li>
 <li><b><code>401 Unauthorized</code></b> - authorization is required for the interaction that was attempted</li>
 <li><b><code>404 Not Found</code></b> - resource type not supported, or not a FHIR end-point</li>
 <li><b><code>405 Method Not Allowed</code></b> - the resource did not exist prior to the update, and the server does not allow client defined ids</li>
 <li><b><code>409 Conflict</code>/<code>412 Precondition Failed</code></b> - version conflict management - see <a href="#concurrency">below</a></li>
 <li><b><code>422 Unprocessable Entity</code></b> - the proposed resource violated applicable FHIR profiles or server business rules.
  If the reason for failure is a conflict that would violate a unique index constraint, the <code>422</code> response MAY include a location header that SHALL indicate the resource for the existing record that would have that same index value</li>
</ul>
<p>
Any of these errors SHOULD be accompanied by an <a href="operationoutcome.html">OperationOutcome</a> resource providing additional detail concerning the issue.
In general, if an instance fails the constraints documented in the CapabilityStatement then the response should be a <code>400</code>,
whereas if the instance fails other non-externally described business rules, the response would be a <code>422</code> error. However,
there's no expectation that servers will tightly adhere to this differentiation (nor is it clear that it makes much difference
whether they do or not). In practice, servers may also return <code>5xx</code> errors in these cases without being deemed non-conformant.
</p>
<p>
For additional information on how systems may behave when processing updates, refer to the <a href="updates.html">Variations between Submitted data and Retrieved data</a> page.
</p>

<div class="draft-content">
<a name="cond-update"></a>
<h4>Conditional update</h4>
<p style="background-color: #ffcccc; border:1px solid grey; padding: 5px; max-width: 790px;">
Unlike this rest of this page, the conditional create, update, patch and delete are trial use until
further experience is gained with their use. Their status will be reviewed in a future version of FHIR.
</p>

<p>
The conditional update interaction allows a client to update an existing resource based on some identification criteria,
rather than by  <a href="resource.html#meta">logical id</a>. To accomplish this, the client issues a <code>PUT</code> as shown:
</p>
<pre class="http">
  PUT [base]/[type]?[search parameters]
</pre>
<p>
When the server processes this update, it performs a search using its standard
<a href="search.html">search facilities</a> for the resource type, with the goal of resolving a single logical id for this request. The action it takes depends
on how many matches are found:
</p>
<ul>
 <li><b>No matches, no id provided</b>: The server creates the resource.</li>
 <li><b>No matches, id provided and doesn't already exist</b>: The server treats the interaction as an <a href="#upsert">Update as Create</a> interaction (or rejects it, if it does not support Update as Create)</li>
 <li><b>No matches, id provided and already exist</b>: The server rejects the update with a <code>409 Conflict</code> error</li>
 <li><b>One Match, no resource id provided OR (resource id provided and it matches the found resource)</b>: The server performs the update against the matching resource as above where, if the resource was updated, the server SHALL return a <code>200 OK</code>; if the resource was created, the server SHALL return a <code>201 Created</code>; and, the server SHALL also return a <code>Location</code> header which contains the new <a href="resource.html#metadata">Logical Id</a> and <a href="resource.html#metadata">Version Id</a> of the created resource version</li>
 <li><b>One Match, resource id provided but does not match resource found</b>: The server returns a <code>400 Bad Request</code> error indicating the client id specification was a problem preferably with an OperationOutcome</li>
 <li><b>Multiple matches</b>: The server returns a <code>412 Precondition Failed</code> error indicating the client's criteria were not selective enough preferably with an OperationOutcome</li>
</ul>
<p>
This variant can be used to allow a stateless client (such as an interface engine) to submit
updated results to a server, without having to remember the logical ids that the server has assigned.
For example, a client updating the status of a lab result from "preliminary" to "final"
might submit the finalized result using <code>PUT path/Observation?identifier=http://my-lab-system|123</code>
</p>
<p>
Note that transactions and conditional create/update/delete are complex interactions and it is
not expected that every server will implement them. Servers that don't support the conditional
update SHOULD return an HTTP <code>400</code> error and MAY include an <a href="operationoutcome.html">OperationOutcome</a>.
</p>
<p>
The resource MAY contain an <code>id</code> element, but does not need to (this is
one of the few cases where a resource exists without an <code>id</code> element).
</p>
<p>
The conditional <code>update</code> interaction also allows a client to update a resource only if a specified version
of the resource does not already exist on the server. The client defines this version using an HL7 defined extension
header "<code>If-None-Match</code>" as the week ETag (<code><a href="resource.html#metadata">Version Id</a></code>) value as shown:
</p>
<pre class="http">
  If-None-Match: W/"[ETag]"
</pre>
<p>
Servers MAY choose to only support the wildcard variant of "<code>If-None-Match</code>" using an asterisk "*" value
to indicate where no existing versions of the resource exist as shown:
</p>
<pre class="http">
  If-None-Match: *
</pre>
</div>

<a name="versionaware"></a>
<a name="concurrency"></a>

<h3>Managing Resource Contention</h3>
<p>
<a href="http://www.w3.org/1999/04/Editing/">Lost Updates</a>, where two clients update the same
resource, and the second overwrites the updates of the first, can be prevented using a combination
of the <a href="https://tools.ietf.org/html/rfc7232#section-2.3">ETag</a> and
<a href="https://tools.ietf.org/html/rfc7232#section-3.1">If-Match</a> header.
This is also known as 'Optimistic Locking'.
</p>
<p>
Note the <a href="https://tools.ietf.org/html/rfc7232#section-3.1">RFC 7232 3.1 If-Match</a> specification
defines the use of <code>"the strong comparison function when comparing entity-tags"</code>. FHIR diverges
from this behavior to use the weak <code>ETag</code> representation.
</p>
<pre class="http">
HTTP 200 OK
Date: Sat, 09 Feb 2013 16:09:50 GMT
Last-Modified: Sat, 02 Feb 2013 12:02:47 GMT
ETag: W/"23"
Content-Type: application/fhir+json
</pre>
<p>
If provided, the value of the <code>ETag</code> SHALL match the value of the version id for the resource. Servers
are allowed to generate the version id in whatever fashion that they wish, so long
as they are valid according to the <a href="datatypes.html#id">id</a> datatype,
and are unique within the address space of all versions of the same resource.
When resources are returned as part of a bundle, there is no <code>ETag</code>, and the
versionId of the resource is used directly.
</p>
<p>
If the client wishes to request a version aware update, it submits the request with an
<code>If-Match</code> header that quotes the ETag from the server:
</p>
<pre class="http">
PUT [base]/Patient/347 HTTP/1.1
If-Match: W/"23"
</pre>
<p>
If the version id given in the <code>If-Match</code> header does not match, the server returns a
<code>412 Precondition Failed</code> status code instead of updating the resource.
</p>
<p>
Servers can require that clients provide an <code>If-Match</code> header by returning <code>400 Bad Request</code>
status codes when no <code>If-Match</code> header is found. Note that a <code>409 Conflict</code> can be returned when the
server detects the update cannot be done (e.g. due to server side pessimistic locking).
</p>

<a name="patch"></a>
<h3>patch</h3>
<p>
As an alternative to updating an entire resource, clients can perform a patch interaction.
This can be useful when a client is seeking to minimize its bandwidth utilization, or
in scenarios where a client has only partial access or support for a resource. The <code>patch</code>
interaction is performed by an HTTP <code>PATCH</code> command as shown:
</p>
<pre class="http">
  PATCH [base]/[type]/[id] {?_format=[mime-type]}
</pre>
<p>
The body of a PATCH interaction SHALL be either:
</p>
<ul>
 <li>a <a href="https://tools.ietf.org/html/rfc6902">JSON Patch</a> document with a content type of <code>application/json-patch+json</code></li>
 <li>an <a href="http://tools.ietf.org/html/rfc5261">XML Patch</a> document with a content type of <code>application/xml-patch+xml</code></li>
 <li>a <a href="fhirpatch.html">FHIRPath Patch</a> parameters resource with <a href="#mime-type">FHIR Content Type</a></li>
</ul>
<p>
In either case, the server SHALL process its own copy of the resource in the format indicated, applying
the operations specified in the document, following the relevant PATCH specification. When the operations
have all been processed, the server processes the resulting document as an <a href="#update"><code>Update</code></a>
interaction; all the version and error handling etc. apply as specified, as does the <a href="#prefer">Prefer Header</a>.
</p>
<p>
Processing PATCH operations may be very version sensitive. For this reason,  servers that support PATCH SHALL support <a href="#versionaware">Concurrency Management</a>.
Clients SHOULD always consider using version specific PATCH operations so that inappropriate
actions are not executed.
</p>
<div class="draft-content">
<a name="cond-patch"></a>
<h4>Conditional patch</h4>
<p style="background-color: #ffcccc; border:1px solid grey; padding: 5px; max-width: 790px;">
Unlike this rest of this page, the conditional create, update, patch and delete are trial use until
further experience is gained with their use. Their status will be reviewed in a future version of FHIR.
</p>
<p>
In addition, servers that support PATCH, and that support <a href="#cond-update">Conditional Update</a> SHOULD
also support conditional PATCH. When the server processes a conditional PATCH, it performs a search using its standard
<a href="search.html">search facilities</a> for the resource type, with the goal of resolving a single logical id for this request. The action it takes depends
on how many matches are found:
</p>
<ul>
 <li><b>No matches</b>: The server returns a <code>404 Not Found</code></li>
 <li><b>One Match</b>: The server performs the update against the matching resource</li>
 <li><b>Multiple matches</b>: The server returns a <code>412 Precondition Failed</code> error indicating the client's criteria were not selective enough</li>
</ul>
</div>
<p>
The server SHALL ensure that the narrative in a resource is not clinically unsafe after the PATCH interaction is performed.
Exactly how this is defined and can be achieved depends on the context, and how narrative is being maintained, but servers may wish to consider:
</p>
<ul>
 <li>If the existing narrative has a status != <code>generated</code>, the server could reject the PATCH interaction</li>
 <li>The server could regenerate the narrative once the interaction has been applied to the data</li>
 <li>In some limited circumstances, an XML PATCH interaction could update the narrative</li>
 <li>The server could delete the narrative, on the basis that some later process will be able to populate it correctly</li>
</ul>
<p>
Processing XML Patch documents is tricky because of namespace handling. Servers SHALL handle
namespaces correctly, but note that FHIR resources only contain two XML namespaces,
for FHIR (<code>http://hl7.org/fhir</code>) and XHTML (<code>http://www.w3.org/1999/xhtml</code>).
</p>
<p>
In the case of a failing <a href="http://jsonpatch.com/#test">JSON Patch test</a> operation, the server returns a <code>422 Unprocessable Entity</code>.
</p>
<p>
For PATCH Examples, see <a href="https://github.com/FHIR/fhir-test-cases/releases">the FHIR test cases</a>.
</p>
<p>
Patch interactions may be performed as part of Batch or Transaction Operations using the FHIRPath Patch format.
</p>
<p>
Patch is not defined for all resources - see <a href="binary.html#patch">note about PATCH on Binary</a>.
</p>
<div class="draft-content">
<a name="jsonpatch-transaction"></a>
<h4>Patch Using JSON Patch (batch/transaction)</h4>
<p style="background-color: #ffcccc; border:1px solid grey; padding: 5px; max-width: 790px;">
The behavior of using <i>JSON Patch in a batch/transaction interaction</i> is trial use until further
experience is gained with its use. Implementer feedback is welcome <a href="http://hl7.org/fhir-issues">here</a>.
</p>
<p>
In addition, servers may support submitting the JSON Patch as a part of a FHIR batch or transaction interaction
using a Binary resource as the payload in order to hold the contents.
</p>
<p>
The following example shows a base64 encoded JSON Path content in a Binary resource applied to a Patient resource in a transaction Bundle:
</p>
<pre class="json" fragment="Bundle">
{
  "resourceType": "Bundle",
  "type": "transaction",
  "entry": [
    {
      "fullUrl": "Patient/1",
      "resource": {
        "resourceType": "Binary",
        "contentType": "application/json-patch+json",
        "data": "WyB7ICJvcCI6InJlcGxhY2UiLCAicGF0aCI6Ii9hY3RpdmUiLCAidmFsdWUiOmZhbHNlIH0gXQ=="
      },
      "request": {
        "method": "PATCH",
        "url": "Patient/1"
      }
    }
  ]
}
</pre>
</div>
<a name="delete"></a>
<h3>delete</h3>
<p>
The <code>delete</code> interaction removes an existing resource. The interaction
is performed by an HTTP <code>DELETE</code> command as shown:
</p>
<pre>
  DELETE [base]/[type]/[id]
</pre>
<p>
The request body SHALL be empty.
</p>
<p>
A delete interaction means that the resource is no longer found through a <a href="#search">search</a> interaction.
Subsequent <a href="#read">non-version specific reads</a> of the resource return a <code>410 Gone</code> HTTP
status code when the server wishes to indicate that the resource is deleted. For security reasons, the
server may return other status codes as defined under <a href="security.html#AccessDenied">Access Denied Response Handling</a>.
Upon successful deletion, or if the resource does not exist at all, the server should return either a
<code>200 OK</code> if the response contains a payload, or a <code>204 No Content</code> with no response payload,
or a <code>202 Accepted</code> if the server wishes to be non-commital about the outcome of the delete.
<!--, or 200 OK status code, with an <a href="operationoutcome.html">OperationOutcome</a>
resource containing hints and warnings about the deletion; if one is sent it SHALL NOT include any errors. -->
</p>
<p>
Whether to support delete at all, or for a particular resource type or a particular instance is at the
discretion of the server based on the policy and business rules that apply in its context.
If the server refuses to delete resources of that type as a blanket policy, then it should return the <code>405
Method Not Allowed</code> status code. If the server refuses to delete a resource because of reasons specific
to that resource, such as referential integrity, it should return the <code>409 Conflict</code> status code.
Note that the servers MAY choose to enforce business rules regarding deletion of resources that are being referenced by other resources, but they also might not do so.
Performing this interaction on a resource that is already deleted has no effect, and the server should return either a
<code>200 OK</code> if the response contains a payload, or a <code>204 No Content</code> with no response payload.
Resources that have been deleted may be "brought back to life" by a subsequent <a href="#href"><code>update</code></a>
interaction using an HTTP <code>PUT</code>.
</p>
<p>
Many resources have a status element that overlaps with the idea of deletion. Each resource type
defines what the semantics of the deletion interactions are. If no documentation is provided, the
deletion interaction should be understood as deleting the record of the resource, with nothing
about the state of the real-world corresponding resource implied.
</p>
<p>
For servers that maintain a version history, the <code>delete</code> interaction does not
remove a resource's version history. From a version history respect,
deleting a resource is the equivalent of creating a special kind of history entry that has
no content and is marked as deleted. Note that
there is no support for deleting past versions - see notes on the <a href="#history">history</a> interaction.
Since deleted resources may be brought back to life, servers MAY include an <code>ETag</code> on the delete response
to allow version contention management when a resource is brought back to life.
</p>
<p>
Note that irrespective of this rule, servers are free to completely delete the resource and it's history
if policy or business rules make this the appropriate action to take.
</p>

<div class="draft-content">
<a name="cdelete"></a>
<h4>Conditional delete</h4>
<p style="background-color: #ffcccc; border:1px solid grey; padding: 5px; max-width: 790px;">
Unlike this rest of this page, the conditional create, update, patch and delete are trial use until
further experience is gained with their use. Their status will be reviewed in a future version of FHIR.
</p>
<p>
The conditional delete interaction allows a client to delete an existing resource or all matching resources based on some selection criteria,
rather than by a specific <a href="resource.html#meta">logical id</a>. To accomplish this, the client issues an HTTP <code>DELETE</code> as shown:
</p>
<pre class="http">
  DELETE [base]/[type]?[search parameters]
  DELETE [base]?[search parameters]
</pre>
<p>
When the server processes this delete, it performs a search as specified using the standard
<a href="search.html">search facilities</a> for the resource type. The action it takes depends
on how many matches are found:
</p>
<ul>
 <li><b>No matches</b> or <b>One Match</b>: The server performs an ordinary <code>delete</code> on the matching resource</li>
 <li><b>Multiple matches</b>: A server may choose to delete all the matching resources, or it may choose to return a <code>412 Precondition Failed</code> error indicating the client's criteria were not selective enough.
   A server indicates whether it can delete multiple resources in its <a href="capabilitystatement-definitions.html#CapabilityStatement.rest.resource.conditionalDelete">Capability Statement (.rest.resource.conditionalDelete)</a></li>
</ul>
<p>
This variant can be used to allow a stateless client (such as an interface engine) to delete
a resource on a  server, without having to remember the logical ids that the server has assigned.
For example, a client deleting a lab atomic result might delete the resource using <code>DELETE /[base]/Observation?identifier=http://my-lab-system|123</code>.
</p>
<p>
Note that transactions and conditional create/update/delete are complex interactions and it is
not expected that every server will implement them. Servers that don't support the conditional
update SHOULD return an HTTP <code>400</code> error and MAY include an <a href="operationoutcome.html">OperationOutcome</a>.
</p>
</div>

<a name="create"></a>
<h3>create</h3>
<p>
The <code>create</code> interaction creates a new resource in a server-assigned location. If the client
wishes to have control over the id of a newly submitted resource, it should use the <a href="#update">update</a>
interaction instead. The <code>create</code> interaction is performed by an HTTP <code>POST</code> command as shown:
</p>
<pre class="http">
  POST [base]/[type] {?_format=[mime-type]}
</pre>
<p>
The request body SHALL be a FHIR Resource of the named type. The resource does not need to have an <code>id</code> element (this is
one of the few cases where a resource exists without an <code>id</code> element). If an <code>id</code> is provided, the
server SHALL ignore it. If the request body includes a <a href="resource.html#meta">meta</a>, the server SHALL
ignore the existing <code>versionId</code> and <code>lastUpdated</code> values.
The server SHALL populate the <code>id</code>, <code>meta.versionId</code> and <code>meta.lastUpdated</code>
with the new correct values. Servers are allowed to review and alter the other metadata values, but SHOULD
refrain from doing so (see <a href="resource.html#meta">metadata description</a> for further information).
</p>
<p>
A server SHOULD otherwise accept the resource as submitted when it accepts the create, and return the same
content when it is subsequently read. However some systems might not be able to do this; see
the note on <a href="#transactional-integrity">transactional integrity</a> for discussion.
</p>
<p>
The server returns a <code>201 Created</code> HTTP status code, and SHALL also return a <code>Location</code> header which
contains the new <a href="resource.html#metadata">Logical Id</a> and <a href="resource.html#metadata">Version Id</a> of
the created resource version:
</p>
<pre class="http">
  Location: [base]/[type]/[id]/_history/[vid]
</pre>
<p>
where <code>[id]</code> and <code>[vid]</code> are the newly created id and version id for the resource version.
The Location header should be as specific as possible - if the server understands versioning, the version is
included. If a server does not track versions, the Location header will just contain [base]/[type]/[id]. The
Location MAY be an absolute or relative URL.
</p>
<p>
Servers SHOULD return an <code>ETag</code> header with the <code>versionId</code> (if versioning is supported) and a <code>Last-Modified</code> header.
The body of response is as described in <a href="http.html#return">Managing Return Content</a>.
</p>
<p>
When the resource syntax or data is incorrect or invalid, and cannot be used to create a new resource, the server returns a <code>400 Bad Request</code> HTTP status code.
When the server rejects the content of the resource because of business rules, the server returns a <code>422 Unprocessable Entity</code> error HTTP status code.
In either case, the server SHOULD include a response body containing an <a href="operationoutcome.html">OperationOutcome</a> with detailed error messages describing the reason for the error.
</p>
<p>
Note: Servers MAY determine that the <code>create</code> request matches an existing record with high confidence and MAY return a <code>201</code>,
effectively making it look to the client as though a new resource had been created, even though the the "created" resource is actually
a pre-existing resource. Add a note that client developers should review all returned data (as they always should for all interactions)
to ensure that it matches expectations.
</p>
<p>
Note: Servers MAY choose to preserve XML comments, instructions, and formatting or JSON whitespace when accepting creates, but are not required to do so. The impact of this on digital signatures may need to be considered.
</p>
<p>
Note: A client may attempt to create a resource containing a <code>SUBSETTED</code> tag. It is at the server's discretion whether to accept requests that are tagged as <code>SUBSETTED</code> and, if so, how to handle them.
</p>
<p>
Common HTTP Status codes returned on FHIR-related errors (in addition to normal HTTP errors related to security, header and content type negotiation issues):
</p>
<ul>
 <li><b><code>400 Bad Request</code></b> - resource could not be parsed or failed basic FHIR validation rules</li>
 <li><b><code>404 Not Found</code></b> - resource type not supported, or not a FHIR end-point</li>
 <li><b><code>422 Unprocessable Entity</code></b> - the proposed resource violated applicable FHIR profiles or server business rules. This should be accompanied by an <a href="operationoutcome.html">OperationOutcome</a> resource providing additional detail</li>
</ul>
<p>
In general, if an instance fails the constraints documented in the CapabilityStatement then the response should be a <code>400</code>,
whereas if the instance fails other non-externally described business rules, the response would be a <code>422</code> error. However,
there's no expectation that servers will tightly adhere to this differentiation (nor is it clear that it makes much difference
whether they do or not). In practice, servers may also return <code>5xx</code> errors in these cases without being deemed non-conformant.
</p>
<p>
For additional information on how systems may behave when processing updates, refer to the <a href="updates.html">Variations between Submitted data and Retrieved data</a> page.
</p>

<div class="draft-content">
<a name="ccreate"></a>
<h4>Conditional create</h4>
<p style="background-color: #ffcccc; border:1px solid grey; padding: 5px; max-width: 790px;">
Unlike this rest of this page, the conditional create, update, patche and delete are trial use until
further experience is gained with their use. Their status will be reviewed in a future version of FHIR.
</p>
<p>
The conditional <code>create</code> interaction allows a client to create a new resource only if some equivalent resource
does not already exist on the server. The client defines what equivalence means in this case by supplying
a FHIR search query using an HL7 defined extension header "<code>If-None-Exist</code>" as shown:
</p>
<pre class="http">
  If-None-Exist: [search parameters]
</pre>
<p>
The parameter just contains the search parameters (what would be in the URL  following the "?").
</p>
<p>
When the server processes this create, it performs a search as specified using its standard
<a href="search.html">search facilities</a> for the resource type. The action it takes depends
on how many matches are found:
</p>
<ul>
 <li><b>No matches</b>: The server processes the create as above where, if the resource is created, the server returns a <code>201 Created</code> HTTP status code, and SHALL also return a <code>Location</code> header which contains the new <a href="resource.html#metadata">Logical Id</a> and <a href="resource.html#metadata">Version Id</a> of the created resource version</li>
 <li><b>One Match</b>: The server ignores the post and returns <code>200 OK</code>, with headers and body populated
 as they would have been if a create had actually occurred. (i.e. the body is set as per the prefer header, location and etag headers set, etc.)</li>
 <li><b>Multiple matches</b>: The server returns a <code>412 Precondition Failed</code> error indicating the client's criteria were not selective enough</li>
</ul>
<p>
This variant can be used to avoid the risk of two clients
creating duplicate resources for the same record. For example, a client posting a new lab result might specify
<code>If-None-Exist: identifier=http://my-lab-system|123</code> to ensure it does not create a duplicate record.
</p>
<p>
Note that transactions and conditional create/update/delete are complex interactions and it is
not expected that every server will implement them. Servers that don't support the conditional
update SHOULD return an HTTP <code>400</code> error and MAY include an <a href="operationoutcome.html">OperationOutcome</a>.
</p>
</div>

<a name="search"></a>
<h3>search</h3>
<p>
This interaction searches a set of resources based on some filter criteria. The interaction can be performed by several different HTTP commands.
</p>
<pre class="http">
  GET [base]/[type]{?[parameters]{&amp;_format=[mime-type]}}
</pre>
<p>
This searches all resources of a particular type using the criteria represented in the parameters.
</p>
<p>
Because of the way that some user agents and proxies treat <code>GET</code> and <code>POST</code> requests, in addition
to the get based search method above, servers that support <i>search</i> SHALL also support a <code>POST</code> based search:
</p>
<pre class="http">
POST  [base]/[type]/_search{?[parameters]{&amp;_format=[mime-type]}}
Content-Type: application/x-www-form-urlencoded

param1=value&amp;param2=value
</pre>
<p>
This has exactly the same semantics as the equivalent <code>GET</code> command. Note that in the POST variant,
parameters may appear in both the URL and the body. Parameters have the same meaning in either place. Since
parameters can repeat, putting them in both places is the same as repeating them (which is valid for some
parameters and not for others).
</p>
<p>
Note: Supporting <code>GET</code> means that PHI (Personal health information) might appear in search
parameters, and therefore in HTTP logs. For this reason logs should be regarded as being as sensitive
as the resources themselves. This is a general requirement irrespective of the use of <code>GET</code>
- see the <a href="security.html#audit">security page</a> for further commentary.
</p>

<p>
All these search interactions take a series of parameters that
are a series of <code>name=value</code> pairs encoded in the URL (or as an <code>application/x-www-form-urlencoded</code> (<a href="https://url.spec.whatwg.org/#application/x-www-form-urlencoded">Specification</a>) submission for a <code>POST</code>).
(See <a href="http://www.w3.org/TR/REC-html40/interact/forms.html#form-content-type">W3C HTML forms</a>).
</p>
<blockquote>
<p>
Note: <code>application/x-www-form-urlencoded</code> is supported for <code>POST</code> so that invoking a search by <code>GET</code> or <code>POST</code> can be
done from HTML forms in a browser (though considerable active content might be required in the browser), although
this is not the main usage.
</p>
</blockquote>
<p>
A HEAD request can also be used - <a href="#head">see below</a>.
</p>
<p>
Searches are processed as specified for the <a href="search.html">Search handling mechanism</a>.
</p>
<p>
If the search succeeds, the server SHALL return a <code>200 OK</code> HTTP status code and the return content SHALL be a <a href="bundle.html">Bundle</a>
with <a href="bundle-definitions.html#Bundle.type">type</a> = <code>searchset</code> containing the results of the search as a collection of
zero or more resources in a defined order. Note that resources returned in the search bundle MAY be located
on the another server than the one that performs the search (i.e. the <a href="bundle-definitions.html#Bundle.entry.fullUrl">Bundle.entry.fullUrl</a> may be different to the <code>[base]</code> from the search URL).
</p>
<p>
The result collection can be long, so servers may use paging. If they do, they SHALL use the method
<a href="#paging">described below</a> (adapted from <a href="https://tools.ietf.org/html/rfc5005">RFC 5005 (Feed Paging and Archiving</a>)
for breaking the collection into pages if appropriate. The server MAY also return an <a href="operationoutcome.html">OperationOutcome</a> resource
within the <code>searchset</code> Bundle entries that contains additional information about the search; if one is sent it SHALL NOT include any
issues with a <code>fatal</code> or <code>error</code> <a href="valueset-issue-severity.html">severity</a>, and it SHALL be marked with a
<a href="valueset-search-entry-mode.html">Bundle.entry.search.mode</a> of <code>outcome</code>.
</p>
<p>
If the search fails (cannot be executed, not that there are no matches), the return value
SHALL be a status code <code>4xx</code> or <code>5xx</code>. If the failure occurs at a FHIR-aware level of processing,
the HTTP response SHOULD be accompanied by an <a href="operationoutcome.html">OperationOutcome</a>.
</p>
<p>
Common HTTP Status codes returned on FHIR-related errors (in addition to normal HTTP errors related to security, header and content type negotiation issues):
</p>
<ul>
 <li><b><code>400 Bad Request</code></b> - search could not be processed or failed basic FHIR validation rules</li>
 <li><b><code>401 Unauthorized</code></b> - authorization is required for the interaction that was attempted</li>
 <li><b><code>404 Not Found</code></b> - resource type not supported, or not a FHIR end-point</li>
</ul>

<a name="vsearch"></a>
<h4>Variant Searches</h4>
<p>
To search a <a href="compartmentdefinition.html">compartment</a>, for either all possible resources or for a particular resource type, respectively:
</p>

<table>
  <tr>
    <td>
      <pre class="http">GET [base]/[Compartment]/[id]/*{?[parameters]{&amp;_format=[mime-type]}}</pre>
    </td>
  </tr>
  <tr>
    <td>
<pre class="http">POST [base]/[Compartment]/[id]/_search{?[parameters]{&amp;_format=[mime-type]}}
Content-Type: application/x-www-form-urlencoded

param1=value&amp;param2=value</pre>
    </td>
  </tr>
  <tr>
    <td>
      <pre class="http">GET [base]/[Compartment]/[id]/[type]{?[parameters]{&amp;_format=[mime-type]}}</pre>
    </td>
  </tr>
  <tr>
    <td>
<pre class="http">POST [base]/[Compartment]/[id]/[type]/_search{?[parameters]{&amp;_format=[mime-type]}}
Content-Type: application/x-www-form-urlencoded

param1=value&amp;param2=value</pre>
    </td>
  </tr>
</table>

<p>
In the first URL the character "<code>*</code>" appears in the URL as a literal to mean 'all types'.  This
is required to distinguish between a simple <code>read</code> operation and a search in that same compartment.
Note that this syntax is not used in POST-based compartment searches, since the <code>_search</code> literal
is used.  So, for example, to retrieve all the observation resources for a particular LOINC code associated 
with a particular encounter:
</p>
<pre>
  GET [base]/Encounter/23423445/Observation?code=2951-2  {&amp;_format=[mime-type]}
</pre>
<p>
Note that there are specific operations defined to support fetching <a href="patient-operation-everything.html">an entire patient record</a>
or <a href="encounter-operation-everything.html">all record for an encounter</a>.
</p>
<p>
It is also possible to search across multiple resource types.  For example, the following searches
would test for matches across both Condition and Observation resources.
</p>
<pre class="http">GET [base]?_type=Condition,Observation&amp;[parameters]{&amp;_format=[mime-type]}</pre>
<pre class="http">POST [base]/_search?{?[parameters]{&amp;_format=[mime-type]}}
Content-Type: application/x-www-form-urlencoded
  
_type=Condition,Observation&amp;[parameters]{&amp;_format=[mime-type]}</pre>

<p>
  For details about searching across multiple types, including search parameter availability, see the 
  <a href="search.html#type">Searching Multiple Resource Types</a> section of the search page.
</p>
<pre class="http">GET [base]?[parameters]{&amp;_format=[mime-type]}</pre>
<pre class="http">POST [base]/_search?{?[parameters]{&amp;_format=[mime-type]}}
Content-Type: application/x-www-form-urlencoded

[parameters]{&amp;_format=[mime-type]}</pre>
<p>
  For details about searching across all types, including search parameter availability, see the 
  <a href="search.html#type">Searching Multiple Resource Types</a> section of the search page.
</p>


<a name="capabilities"></a>
<h3>capabilities</h3>
<p>
The <code>capabilities</code> interaction retrieves the information about a server's capabilities - which portions of this specification it supports.
The interaction is performed by an HTTP <code>GET</code> command as shown:
</p>
<pre class="http">
  GET [base]/metadata{?mode=[mode]} {&amp;_format=[mime-type]}
</pre>
<p>
Applications SHALL return a resource that describes the functionality of the server end-point. The information returned depends
on the value of the <code>mode</code> parameter:
</p>
<table class="grid">
 <tr><td><code>full</code> (or mode not present)</td><td>A <a href="capabilitystatement.html">Capability Statement</a> that specifies which resource types and interactions are supported</td></tr>
 <tr><td><code>normative</code></td><td>As above, but only the normative portions of the Capability Statement</td></tr>
 <tr><td><code>terminology</code></td><td>A <a href="terminologycapabilities.html">TerminologyCapabilities</a> resource that provides further information about terminologies which are supported by the server</td></tr>
</table>
<p>
Servers MAY ignore the mode parameter and return a CapabilityStatement resource. Note: servers might be required to support this parameter in further versions of this specification.
</p>
<p>
If a <code>404 Not Found</code> is returned from the <code>GET</code>, FHIR (or the specified version) is not supported on the
nominated service url. An <code>ETag</code> header SHOULD be returned with the Response. The value of the ETag header SHALL change if the
returned resource changes.
</p>
<p>
Servers SHOULD check for the <a href="#version-parameter">fhirVersion MIME-type parameter</a> when processing this request.
</p>
<p>
The resource returned typically has an arbitrary id, and no meta element, though it is not prohibited.
Capability statements can become quite large; servers are encouraged to support the
<a href="search.html#summary"><code>_summary</code></a> and <a href="search.html#elements"><code>_elements</code></a>
parameters on the capabilities interaction, though this is not required. In addition, servers are encouraged to
implement the <a href="capabilitystatement-operation-subset.html">$subset</a> and <a href="capabilitystatement-operation-implements.html">$implements</a>
operations to make it easy for a client to check conformance.
</p>
<p>
In addition to this <code>capabilities</code> interaction, a server may also choose to provide the
standard set of interactions (<code>read</code>, <code>search</code>, <code>create</code>, <code>update</code>) defined on this page
for the <a href="capabilitystatement.html">CapabilityStatement Resource</a> end-point.
This is different from the <code>capabilities</code> interaction:
</p>
<table class="grid">
 <tr><td><code>capabilities</code> interaction</td><td>returns a capability statement describing the server's current operational functionality</td></tr>
 <tr><td>CapabilityStatement end-point</td><td>manages a repository of capability statements (e.g. the HL7 capability statement registry)</td></tr>
</table>
<p>
All servers are required to support the <code>capabilities</code> interaction, but servers may choose whether they wish to support the CapabilityStatement end-point,
just like any other end-point.
</p>

[%impl-note%]
<a name="cap-st-note"></a>
In DSTU 2 and earlier, the resource that this interaction returned was named "Conformance".
Clients often connect to a server, and use the <code>capabilities</code> interaction to check whether they are version
and/or feature compatible with the server. Such clients should be able to process either a Conformance or a
CapabilityStatement resource.
[%end-note%]


<a name="transaction"></a>
<h3>batch/transaction</h3>
<p>
The <code>batch</code> and <code>transaction</code> interactions submit a set of actions to perform on a server in a single HTTP request/response.
The actions may be performed independently as a "batch", or as a single atomic "transaction" where
the entire set of changes succeed or fail as a single entity. Multiple actions on multiple resources
of the same or different types may be submitted, and they may be a mix of other interactions defined
on this page (e.g. <code>read</code>, <code>search</code>, <code>create</code>, <code>update</code>, <code>delete</code>, etc.), or using the <a href="operations.html">operations</a>
framework.
</p>
<p>
The <code>transaction</code> mode is especially useful where one would otherwise need multiple interactions, possibly
with a risk of loss of referential integrity if a later interaction fails (e.g. when storing
a Provenance resource and its corresponding target resource or <a href="https://wiki.ihe.net/index.php/Mobile_access_to_Health_Documents_(MHD)">IHE-MHD transaction "Provide Document Resources"</a> 
with some number of DocumentReference, List, and Binary resources).
</p>
<p>
Note that transactions and conditional create/update/delete are complex interactions and it is
not expected that every server will implement them. Servers that don't support the batches
or transactions SHOULD return an HTTP <code>400</code> error and MAY include an <a href="operationoutcome.html">OperationOutcome</a>.
</p>
<p>
A <code>batch</code> or <code>transaction</code> interaction is performed by an HTTP <code>POST</code> command as shown:
</p>
<pre class="http">
  POST [base] {?_format=[mime-type]}
</pre>
<p>
The content of the post submission is a <a href="bundle.html">Bundle</a> with <a href="bundle-definitions.html#Bundle.type">Bundle.type</a> = <code><a href="valueset-bundle-type.html#batch">batch</a></code> or <code><a href="valueset-bundle-type.html#transaction">transaction</a></code>.
Each entry SHALL carry <code>request</code> details (<a href="bundle-definitions.html#Bundle.entry.request">Bundle.entry.request</a>)
that provides the HTTP details of the action in order to inform the system processing the batch or transaction
what to do for the entry. If the HTTP command is a <code>PUT</code> or <code>POST</code>, then the entry
SHALL contain a resource for the body of the action.
The resources in the bundle are each processed separately as if they were an individual
interaction or operation as otherwise described on this page, or the <a href="operations.html">Operations
framework</a>. The actions are subject to the normal processing for each,
including the <a href="resource.html#meta">meta element</a>, verification and version aware updates,
and <a href="#transactional-integrity">transactional integrity</a>. In the case of a batch each
entry is treated as if an individual interaction or operation, in the case of a transaction all
interactions or operations either succeed or fail together (see below).
</p>
<p>
Examples:
</p>
<ul>
 <li><a href="bundle-transaction.html">Transaction Example</a> with <a href="bundle-response.html">Matching Response</a></li>
 <li><a href="bundle-request-medsallergies.html">Batch request to fetch Meds &amp; Allergies</a> with <a href="bundle-response-medsallergies.html">Response</a></li>
 <li><a href="bundle-request-simplesummary.html">Batch request to fetch simple Patient Summary</a> with <a href="bundle-response-simplesummary.html">Response</a></li>
</ul>

<a name="brules"></a>
<h4>Batch Processing Rules</h4>
<p>
For a <code>batch</code>, there SHALL be no interdependencies between the different entries
in the Bundle that cause change on the server. The success or failure of one change SHOULD
not alter the success or failure or resulting content of another change. Servers SHOULD
validate that this is the case. Note that it is considered that servers execute the batch
in the same order as that specified below for transactions, though the order of execution
should not matter given the previous rule.
</p>
<p>
References within a <code>Bundle.entry.resource</code> to another <code>Bundle.entry.resource</code> that is being
created within the batch are considered to be non-conformant.
</p>
<p>
When processing the batch, the HTTP response code is <code>200 OK</code> if the batch was processed correctly, regardless of the success of the
operations within the Batch. To determine the status of the operations, look inside the returned Bundle. A response code on an
entry of other than <code>2xx</code> (<code>200</code>, <code>202</code> etc) indicates that processing the request in the entry failed.
</p>

<a name="trules"> </a>
<h4>Transaction Processing Rules</h4>
<p>
For a <code>transaction</code>, servers SHALL either accept all actions (i.e. process each entry resulting in a <code>2xx</code> or <code>3xx</code> response code) 
and return an overall <code>200 OK</code>, along with a
response bundle (see below), or reject all resources and return an HTTP <code>400</code> or <code>500</code> type
response. It is not an error if the submitted bundle has no resources in it.
The outcome of processing the transaction SHALL NOT depend on the order
of the resources in the transaction. A resource can only appear in a transaction
once (by identity).
</p>
<p>
Because of the rules that a transaction is atomic where all actions pass or fail
together and the order of the entries doesn't matter, there is a particular order in which to process the actions:
</p>
<ol>
 <li>Process any <a href="#delete"><code>delete</code></a> (DELETE) interactions</li>
 <li>Process any <a href="#create"><code>create</code></a> (POST) interactions</li>
 <li>Process any <a href="#update"><code>update</code></a> (PUT) or <a href="#patch"><code>patch</code></a> (PATCH) interactions</li>
 <li>Process any <a href="#read"><code>read</code></a>, <a href="#vread"><code>vread</code></a>, <a href="#search"><code>search</code></a> or <a href="#history"><code>history</code></a> (GET or HEAD) interactions</li>
 <li>Resolve any conditional references</li>
</ol>
<p>
If any resource identities (including resolved identities from conditional update/delete) overlap in steps 1-3,
then the transaction SHALL fail.
</p>

<p>
A transaction may include references from one resource to another in the bundle, including
circular references where resources refer to each other.
When the server assigns a new id to any resource in the bundle which has a <a href="#create"><code>create</code></a> (POST) method
as part of the processing rules above, it SHALL also update any references to that resource in the same bundle as they
are processed  (see <a href="bundle.html#bundle-unique">about Ids in a bundle</a>). References to resources that are not
part of the bundle are left untouched.
</p>
<p>
Servers SHALL replace all matching links in the bundle, found in the resource ids,
<a href="references.html">resource references</a>, elements of type <a href="datatypes.html#uri">uri</a>,
<a href="datatypes.html#url">url</a>, <a href="datatypes.html#oid">oid</a>, <a href="datatypes.html#uuid">uuid</a>,
and <code>&lt;a href=""</code> &amp; <code>&lt;img src=""</code> in the Narrative elements in DomainResource.text or
Composition.section.text. Elements of type canonical are not replaced. Servers SHOULD also replace references found
in elements of type <a href="datatypes.html#markdown">markdown</a>, including extensions. Replacement within URLs is
based on either an exact match or a match of the portion of the URL preceding a '#'.
</p>
<p>
E.g. If posting a resource with a reference of <code>"http://somewhere.org/StructureDefinition/myprofile#some.element.path"</code>
and <code>"http://somewhere.org/StructureDefinition/myprofile"</code> is the fullUrl of another entry in the transaction, the server
would replace the 'myprofile' id portion of the reference with whatever id it assigns and, if the target server base
differs from <code>"http://somewhere.org"</code>, would also replace the base portion of the URL.
</p>
<p>
Similarly if the narrative includes <code>&lt;img src="urn:uuid:someguid"/&gt;</code> and there is an entry within the
transaction creating a Binary with a full url of <code>"urn:uuid:someguid"</code>, that entire URL would be replaced with the new
absolute URL of the created Binary resource.
</p>
<p>
If a reference within a transaction contains a version-specific reference, the expectation is that the referenced version
already exists - either on the target server or on another server. If the intention is to point to a version created as
part of the current transaction, the reference should be a version-independent reference and SHALL include the
<a href="[%extensions-location%]StructureDefinition-resolve-as-version-specific.html">extension resolve-as-version-specific</a>
extension, requesting that the server update the reference to be version-specific to the
target version produced by this transaction. If there is no entry in the transaction Bundle that creates a new version of
the referenced resource, this MAY be treated as an error.
</p> 
<p>
Version-specific references may create dependencies between creates and updates that the transaction will need to accommodate.
For example, if a 'create' has a 'resolve-as-version-specific-reference' to an updated entry, even though the 'create' will
need to happen before the 'update' (per transaction rules), the created record will need to be revised to include the
version-specific reference to the newly updated version of the reference target.
</p>
<p>
Note, the use of the <code><a href="references.html">Reference</a></code> datatype standard
<code><a href="[%extensions-location%]StructureDefinition-resolve-as-version-specific.html">extension resolve-as-version-specific</a></code>
is a request to turn the non-versioned reference into a reference to the most recent version of the target
resource. In the case of a resource created in the transaction, the reference becomes a reference to the
initial version. In the case of an update or conditional create, the reference becomes a reference to the
new version. Systems that support this extension SHALL remove the extension as part of the transaction
reference resolution process.  It is not guaranteed that all systems will recognize this extension or be
able to apply it. If the extension is not supported or versioned references are not supported, the
resulting reference will be version-agnostic. A client can attempt to perform a subsequent update/patch to
force a version-specific reference if they wish.
</p>
<p>
When processing a <a href="#create"><code>create</code></a> (POST), the full URL is treated as the id of the resource on the
source, and is ignored; the server generates an id for the resource. For updates,
the server performs a mapping between the fullUrl specified and the local URL the server
knows that instance as, if possible. If the server does not have a mapping for the fullUrl,
the server ignores the base URL and attempts an update assuming the base is the same
as the server base.  This allows the same transaction bundle to be sent to multiple systems
without changing the fullUrls for each target.
</p>
<p>
When processing a batch or transaction, a server MAY choose to honor existing
logical ids (e.g. <code>Observation/1234</code> remains as <code>Observation/1234</code> on the server), but
since this is only <a href="#upsert">safe in controlled circumstances</a>, servers
may choose to assign new ids to all submitted resources, irrespective of any claimed
logical <code>id</code> in the resource, or <code>fullUrl</code> on entries in the batch/transaction.
</p>

<p><b>Conditional References</b></p>
<p>
When constructing the bundle, the client might not know the logical id of a resource, but it may
know identifying information - e.g. an identifier. This situation arises commonly when building
transactions from v2 messages. The client could resolve that identifier to a logical id using
a search, but that would mean that the resolution to a logical id does not occur within the
same transaction as the commit (as well as significantly complicating the client). Because
of this, in a transaction (and only in a transaction), references to resources may be replaced
by a search URI that describes how to find the correct reference:
</p>
<div class="example">
<pre class="xml">
 &lt;Bundle xmlns=&quot;http://hl7.org/fhir&quot;&gt;
   &lt;id value=&quot;20160113160203&quot; /&gt;
   &lt;type value=&quot;transaction&quot; /&gt;
   &lt;entry&gt;
     &lt;fullUrl value=&quot;urn:uuid:c72aa430-2ddc-456e-7a09-dea8264671d8&quot; /&gt;
     &lt;resource&gt;
       &lt;Observation&gt;
         &lt;subject&gt;
            &lt;reference value=&quot;Patient?identifier=12345&quot;/&gt;
         &lt;/subject&gt;
         &lt;--! rest of resource omitted --&gt;
       &lt;/Observation&gt;
     &lt;/resource&gt;
     &lt;request&gt;
       &lt;method value=&quot;POST&quot; /&gt;
     &lt;/request&gt;
   &lt;/entry&gt;
 &lt;/Bundle&gt;
</pre>
</div>
<p>
The search URI is relative to the server's [base] path, and always starts with
a resource type: <code>[type]?parameters...</code>. Only filtering parameters
are allowed; none of the parameters that control the return of resources
are relevant.
</p>
<p>
When processing transactions, servers SHALL:
</p>
<ul>
 <li>check all references for search URIs</li>
 <li>For search URIs, use the search to locate matching resources</li>
 <li>if there are no matches, or multiple matches, the transaction fails, and an error is returned to the user</li>
 <li>if there is a single match, the server replaces the search URI with a reference to the matching resource</li>
</ul>


<a name="transaction-response"></a>
<h4>Batch/Transaction Response</h4>

<p>
For a batch, or a successful transaction, the response the server SHALL
return a <a href="bundle.html">Bundle</a> with <a href="bundle-definitions.html#Bundle.type">type</a>
set to <code>batch-response</code> or <code>transaction-response</code> that contains one entry for each entry in the
request, in the same order, with the outcome of processing the entry. For a failed transaction,
the server returns a single <a href="operationoutcome.html">OperationOutcome</a> instead of a Bundle.
</p>
<p>
A client may use the returned Bundle to track the outcomes of processing the entry,
and the identities assigned to the resources by the server. Each entry element SHALL
contain a <code>response</code> element which details the outcome of processing the
entry - the HTTP status code and, where applicable, the <code>Location</code> and
<code>ETag</code> header values, which are used for identifying and versioning the
resources. In addition, a resource may be included in the entry, as specified by
the <a href="#prefer">Prefer</a> header.
</p>


<a name="other-bundles"></a>
<h4>Accepting other Bundle types</h4>

<p>
A server may choose to accept bundle types other than <code>batch</code> or <code>transaction</code> when <code>POST</code>ed to the [base] URL.
</p>
<p>
Bundles of type <code>history</code> inherently have the same structure as a <code>transaction</code>, and
can be treated as either a transaction or batch, so servers SHOULD accept a history Bundle - this makes it
possible to replicate data from one server to another easily using a pub/sub model. Note, however, that
the original transaction boundaries might not be represented in a history list, and a resource may occur
more than once in a history list, so servers processing history bundles must have some strategy to manage this.
When processing a history bundle via a transaction, any entries with the request method of POST must use the
<code>Bundle.entry.resource.id</code> (which must match the <code>Bundle.entry.response.location</code>) for
that resource so that references are preserved.
</p>
<p>
For other Bundle types, should the server choose to accept them, there will be
no <code>request</code> element (note that every entry will have a resource).
In this case, the server treats the entry as either a create or an update interaction,
depending on whether it recognizes the identity of the resource - if the identity
of the resource refers to a valid location on the server, it should treat it
as an update to that location. Note: this option allows a client to delegate
the matching process to the server.
</p>


<a name="history"></a>
<h3>history</h3>
<p>
The history interaction retrieves the history of either a particular resource, all resources of
a given type, or all resources supported by the system. These three variations of the history
interaction are performed by HTTP <code>GET</code> command as shown:
</p>
<pre>
  GET [base]/[type]/[id]/_history{?[parameters]&amp;_format=[mime-type]}
  GET [base]/[type]/_history{?[parameters]&amp;_format=[mime-type]}
  GET [base]/_history{?[parameters]&amp;_format=[mime-type]}
</pre>
<p>
The return content is a <a href="bundle.html">Bundle</a> with
<a href="bundle-definitions.html#Bundle.type">type</a> set to <code>history</code> containing the
specified version history, sorted with oldest versions last, and including deleted resources.
Each entry SHALL minimally contain at least one of: a <code>resource</code> which holds the resource as
it is at the conclusion of the interaction, or a <code>request</code> with <code>entry.request.method</code>
The <code>request</code> provides information about the result of the interaction that
 led to this new version, and allows, for instance, a subscriber system to
 differentiate between newly created resources and updates to existing resources. The principal reason a <code>resource</code> might be missing
is that the resource was changed by some other channel rather than via the RESTful interface. If
the <code>entry.request.method</code> is a <code>PUT</code> or a <code>POST</code>, the entry
SHALL contain a resource.
</p>
<p>
Interactions (<a href="#create"><code>create</code></a>, <a href="#update"><code>update</code></a>, <a href="#patch"><code>patch</code></a>,
and <a href="#delete"><code>delete</code></a>) or operations that change/delete/add resources create history entries. Note, the result of a
<a href="#patch"><code>patch</code></a> (PATCH) interaction is represented as an <a href="#update"><code>update</code></a> (PUT) interaction
in the history Bundle. In addition, operations may produce side-effects such as new AuditEvent resources; these are represented as
<a href="#create"><code>create</code></a> (POST) interactions in their own right. New resources or updates to existing resources that are
triggered by operations also appear in the history, as do updates to the resources that result from interactions outside the scope of the RESTful interface.
</p>
<p>
A HEAD request can also be used - <a href="#head">see below</a>.
</p>
<p>
A <code>create</code> interaction is represented in a history interaction in the following way:
</p>
<pre class="xml">
  &lt;entry&gt;
    &lt;fullUrl value="http://example.org/fhir/Patient/23424"/&gt;
    &lt;resource&gt;
      &lt;Patient&gt;
        &lt;!-- the id of the created resource --&gt;
        &lt;id value=&quot;23424&quot;/&gt;
        &lt;!-- snip --&gt;
      &lt;/Patient&gt;
    &lt;/resource&gt;
    &lt;request&gt;
      &lt;!-- POST: this was a create --&gt;
      &lt;method value="POST"/&gt;
      &lt;url value="Patient"/&gt;
    &lt;/request&gt;
    &lt;!-- response carries the instant the server processed the create --&gt;
    &lt;response&gt;
      &lt;lastModified value="2014-08-15T10:35:02.034Z"/&gt;
    &lt;/response&gt;
  &lt;/entry&gt;
</pre>
<p>
A <code>delete</code> interaction is represented in a history interaction in the following way:
</p>
<pre class="xml">
  &lt;entry&gt;
    &lt;fullUrl value="http://example.org/fhir/Patient/23424"/&gt;
    &lt;!-- no resource included for a delete --&gt;
    &lt;request&gt;
      &lt;method value="DELETE"/&gt;
      &lt;url value="Patient/23424"/&gt;
    &lt;/request&gt;
    &lt;!-- response carries the instant the server processed the delete --&gt;
    &lt;response&gt;
      &lt;lastModified value="2014-08-20T11:05:34.174Z"/&gt;
    &lt;/response&gt;
  &lt;/entry&gt;
</pre>
<p>
Notes:
</p>
<ul>
 <li>conditional creates, updates and deletes are converted to direct updates and deletes in a history list</li>
 <li>operations do not appear directly in the history log, but side effects (e.g. creation of audit logs. stored binaries, etc.) will appear where relevant</li>
 <li>The resource in the entry is the resource as processed by the server, not as submitted by the client (<a href="updates.html">may be different</a>)</li>
 <li>The server SHOULD populate at least <a href="bundle-definitions.html#Bundle.entry.response.lastModified">response.lastModified</a> so the time of processing is clear in the history record</li>
 <li>Servers may choose to only record successful interactions. Servers may choose to only use <code>200 OK</code> instead of other more specific success codes</li>
 <li>There may be more than one version of a given resource in the history</li>
</ul>
<p>
In addition to the standard <code>_format</code> parameter, the parameters to this interaction may also include:
</p>
<table class="grid">
  <tr><th>Param Name</th><th>Param Type</th><th>Description</th></tr>
  <tr><td><a href="search.html#count"><code>_count</code></a></td><td><a href="search.html#number"><code>integer</code></a></td><td>The maximum number of search results on a page, excluding related resources included by _include or _revinclude or OperationOutcomes. The server is not bound to return the number requested, but cannot return more</td></tr>
  <tr><td><code>_since</code></td><td><a href="search.html#date"><code>instant</code></a></td><td>Only include resource versions that were created at or after the given instant in time</td></tr>
  <tr><td><code>_at</code></td><td><a href="search.html#date"><code>date(Time)</code></a></td><td>Only include resource versions that were current at some point during the time period specified in the date time value (see <a href="search.html#date">Search notes on date searching</a>)</td></tr>
  <tr><td><a href="search.html#list"><code>_list</code></a></td><td><a href="search.html#reference"><code>reference</code></a></td><td>Only include resource versions that are referenced in the specified list (<a href="lifecycle.html#current">current list references</a> are allowed)</td></tr>
  <tr><td><a href="search.html#sort"><code>_sort</code></a></td><td><a href="search.html#string"><code>string</code></a></td><td>Allowed sort values are limited to:
  <ul>
    <li><b>-_lastUpdated</b> (default) - sort in descending lastUpdated order</li>
    <li><b>_lastUpdated</b> - sort in ascending lastUpdated order</li>
    <li><b>none</b> - data will have no defined sort order</li>
  </ul>
  </td></tr>
</table>
<p>
There are no prefixes or modifiers allowed on any of the History interaction parameters.
</p>
<p>
Each of these parameters SHALL NOT appear more than once.
</p>
<p>
The history list can be restricted to a limited period by specifying a <code>_since</code> parameter which contains a full date time with time zone.
Clients should be aware that due to timing imprecision, they may receive notifications of a resource update on the boundary instant more than once. Servers are
not required to support a precision finer than by second.
</p>
<p>
The updates list can be long, so servers may use paging. If they do, they SHALL use the method <a href="#paging">described
below</a> for breaking the list into pages if appropriate, and respect the specified _count across pages.
</p>
<p>
The <code>history</code> interaction can be used to set up a subscription from one system
to another, so that resources are synchronized between them. Refer to the <a href="subscriptions.html">Subscription framework</a>
for an alternate means of system synchronization.
</p>
<p>
Additional Notes about maintaining a history of resources:
</p>
<ul>
 <li>The history is a record version history on a per-resource basis. It is not intended to support concurrent versions, or multi-branch version history</li>
 <li>Accordingly, there is no way to update or delete past versions of the record, except that the <a href="resource-operations.html">metadata can be modified</a> (mainly for access control purposes)</li>
 <li>All past versions of a resource are considered to be superceded, and no longer active, but retained for audit/integrity purposes</li>
 <li>In the case that a past version of a resource needs to be explicitly documented as <a href="lifecycle.html#error">'entered-in-error'</a>, use a <a href="provenance.html">Provenance</a> resource pointing to the past version of the resource</li>
 <li>When tracing the history of a specific resource, applications should retrieve any provenance resources relating to the resource or its past versions</li>
 <li>If a request is made for a history that is not available (e.g. the system does not keep a history for the type, or the particular instance), the server should return a <code>404 Not Found</code> along with an <a href="operationoutcome.html">OperationOutcome</a> explaining the problem</li>
</ul>

<p>
There is a caveat with the <code>_list</code> parameter, associated with changes to the list
while making repeated periodic queries; if the list changes, the response will include
changes to the resources in the list for the period specified, but will omit both later
changes to items no longer in the list, or older changes associated with items in the list.
This might not be a problem, but implementers should be aware of this issue.
</p>

<a name="transactional-integrity"></a>
<h3>Transactional Integrity</h3>
<p>
When processing <a href="#create">create</a> and <a href="#update">update</a>
interactions, a FHIR server is not obliged to accept the entire resource as it
is; when the resource is retrieved through a <a href="#read">read</a> interaction
subsequently, the resource may be different. The difference may arise for
several reasons:
</p>
<ul>
 <li>The server merged updated content with existing content</li>
 <li>The server applied business rules and altered the content</li>
 <li>The server does not fully support all the features or possible values of the resource</li>
</ul>
<p>
Note that there is no general-purpose method to make merging with existing content or
altering the content by business rules safe or predictable - what is possible,
safe and/or required is highly context dependent. These kinds of behaviors may
be driven by security considerations. With regard to incomplete support, clients can consult the server's
base CapabilityStatement <a href="capabilitystatement-definitions.html#CapabilityStatement.profile">profile</a> references to determine which features or
values the server does not support.
</p>
<p>
The <a href="#patch">PATCH operation</a> offers some support for making changes to a part of a resource and should
be used where a client wishes to change just part of a resource, though transactional integrity
issues are still important.
</p>
<p>
To the degree that the server alters the resource for any of
the 3 reasons above, the FHIR server will create implementation
consequences for the eco-system that it is part of, which will
need to be managed (i.e. it will cost more). For this reason, servers
SHOULD change the resource as little as possible, given the constraints
of the system exposing the FHIR resource. However due to the variability
that exists within healthcare, this specification allows that servers
MAY alter the resource on create/update.
</p>
<p>
Similarly, to the degree that an implementation context makes special
rules about merging content or altering the content, that context will
become more expensive to maintain.
</p>
<p>
Although these rules are stated with regard to servers, a similar
concept applies to clients - to the degree that different client
systems interacting with the server do not support the same feature
set, the clients and/or the server will be forced to implement custom
logic to prevent information from being lost or corrupted.
</p>
<p>
Some of these problems can be mitigated by following a pattern
built on top of version-aware updates. In this pattern:
</p>
<ul>
 <li>The server provides a <a href="#read"><code>read</code></a> interaction for any resource it accepts <a href="#update"><code>update</code></a> interactions on</li>
 <li>Before updating, the client <a href="#read"><code>read</code>s</a> the latest version of the resource</li>
 <li>The client applies the changes it wants to the resource, leaving other information intact (note the <a href="extensibility.html#exchange">extension related rules</a> around this)</li>
 <li>The client writes the result back as an <a href="#update"><code>update</code></a> interaction, and is able to handle a <code>409</code> or <code>412</code> response (usually by trying again)</li>
</ul>
<p>
If clients follow this pattern, then information from other systems
that they do not understand will be maintained through the update.
</p>
<p>
Notes:
</p>
<ul>
 <li>A server MAY to choose to maintain the information that would be lost, but there is no defined way for a server to determine whether the client omitted the information because it wasn't supported (perhaps in this case) or whether it wishes to delete the information.</li>
 <li>If a server has changed the content of the resource from what was submitted before the records was stored, the server SHOULD either return the record (regardless of the <code>PREFER</code> response header) or omit the etag from the response.</li>
 <li>If a client receives a copy of the resource in the response body of a create, update or patch, it SHOULD use the returned content as the basis for subsequent update or patch requests.</li>
 <li>This behavior might not be strictly necessary if out-of-band agreements are in place to ensure data consistency is maintained.</li>
</ul>
<a name="conformance-rules"></a>
<h4>Conformance</h4>
<p>
Both client and server systems SHOULD clearly document how transaction
integrity is handled, in the documentation in the <a href="capabilitystatement.html">CapabilityStatement</a>.
</p>



<a name="paging"></a>
<h3>Paging</h3>
<p>
Servers SHOULD support paging for the results of a <a href="#search">search</a> or <a href="#history">history</a> interaction,
and if they do, they SHALL conform to this method (adapted from <a href="https://tools.ietf.org/html/rfc5005">RFC 5005 (Feed
Paging and Archiving)</a> for sending continuation links to the client when returning a <a href="bundle.html">Bundle</a>
(e.g. with <code>history</code> and <code>search</code>). If the server does not do this then there is no way to continue paging.
</p>
<p>
This example shows the third page of a search result:
</p>

<pre class="xml">
&lt;Bundle xmlns="http://hl7.org/fhir"&gt;
  &lt;!-- snip metadata --&gt;
  &lt;!-- This Search url starts with base search, and adds the effective
    parameters, and additional parameters for search state. All searches
    SHALL return this value.

	  In this case, the search continuation method is that the server
    maintains a state, with page references into the stateful list.
	--&gt;
  &lt;link&gt;
    &lt;relation value=&quot;self&quot;&gt;
    &lt;url value=&quot;http://example.org/Patient?name=peter&amp;stateid=23&amp;page=3&quot;/&gt;
  &lt;/link&gt;
  &lt;!-- 4 links for navigation in the search. All of these are optional, but recommended --&gt;

  &lt;link&gt;
    &lt;relation value=&quot;first&quot;/&gt;
    &lt;url value=&quot;http://example.org/Patient?name=peter&amp;stateid=23&amp;page=1&quot;/&gt;
  &lt;/link&gt;
  &lt;link&gt;
    &lt;relation value=&quot;previous&quot;/&gt;
    &lt;url value=&quot;http://example.org/Patient?name=peter&amp;stateid=23&amp;page=2&quot;/&gt;
  &lt;/link&gt;
  &lt;link&gt;
    &lt;relation value=&quot;next&quot;/&gt;
    &lt;url value=&quot;http://example.org/Patient?name=peter&amp;stateid=23&amp;page=4&quot;/&gt;
  &lt;/link&gt;
  &lt;link&gt;
    &lt;relation value=&quot;last&quot;/&gt;
    &lt;url value=&quot;http://example.org/Patient?name=peter&amp;stateid=23&amp;page=26&quot;/&gt;
  &lt;/link&gt;

  &lt;!-- then the search results... --&gt;
&lt;/Bundle&gt;
</pre>

<p>
A server MAY inform the client of the total number of resources returned by the interaction for which the results are paged
using  the <a href="bundle-definitions.html#Bundle.total">Bundle.total</a>.
</p>
<p>Note that for search, where <code>_include</code> can be used to return additional related resources, the total number
of resources in the feed may exceed the number indicated in totalResults.</p>
<p>
In the case of a <code>search</code>, the initial request may be made via a POST, but the
follow up page requests will be made via GET requests. However servers SHOULD allow for a
client to convert the follow up requests to be made via a POST.
</p>

<p>
  The links in the search are opaque to the client, have no dictated structure, and only the
  server understands them. The client must use the server supplied links in order
  to traverse the pages.
</p>
<p>
  A server MAY add additional state tracking parameters to the links, as shown in the example above,
  though the server need not use a stateful paging method as shown in this example.
</p>
<a name="continuity"> </a>
<h4>Paging Continuity &amp; Integrity</h4>
<p>
It is at the discretion of the server how to best ensure that the continuation retains 
integrity in the context of ongoing changes to the resources. While a client pages 
through the results of a search, the underlying record set might change, with resources
being added, deleted, or moved in the natural sort order. In principle, servers have 
three different approaches to choose from:
</p>
<ol>
 <li>Remember the result set as it was at the time of the search, and return the resources as they <i>were</i>, 
    preferably using version specific references (with the consequence that they might be current when returned)</li>
 <li>Remember the result set as it was at the time of the search, and return the resources as they <i>are</i> (with the consequence that they might no longer qualify to be in the search)</li>
 <li>Repeat the search each time, with the consequence that the client may miss resources or get duplicates as they move between pages when the search set changes</li>
</ol>
<p>
The appropriate choice may be dictated by server architecture, and also by considerations
around the semantics of the search and the rate at which the underlying resources are 
updated, created or deleted.
</p>
[%impl-note%]
Clients should avoid making assumptions about which behavior a server is implementing.
At present, there is no way for a client to interrogate the server to determine how
paging continuity and integrity issues are handled. This may be addressed in the future,
and feedback is welcome.
[%end-note%]


<a name="head"/>
<h3>Support for HEAD</h3>

<p>
Anywhere that a GET request can be used, a HEAD request is also allowed. HEAD requests are treated as
specified in HTTP: same response as a GET, but with no body.
</p>
<p>
Servers that do not support HEAD MUST respond in accordance with the HTTP specification,
for example using a <code>405 Method Not Allowed</code> or a <code>501 ("not implemented")</code>.
</p>

<a name="custom"> </a>
<h3>Custom Headers</h3>
<p>
This specification defines or recommends some custom headers that implementers
can use to assist with deployment/debugging purposes:
</p>
<table class="grid">
  <tr>
    <td><b>Tag</b></td>
    <td><b>Direction</b></td>
    <td><b>MDN</b></td>
    <td><b>RFC</b></td>
    <td><b>Notes</b></td>
  </tr>

 <tr>
  <td><code>X-Request-Id</code></td>
  <td>both</td>
  <td></td>
  <td></td>
  <td>A unique id to for the request/response assigned by either client or server. Request: assigned by the client. Response: assigned by the server</td>
 </tr>
 <tr>
  <td><code>X-Correlation-Id</code></td>
  <td>both</td>
  <td></td>
  <td></td>
  <td>A client assigned request id echoed back in the response</td>
 </tr>
 <tr>
  <td><code>X-Forwarded-For</code></td>
  <td>request</td>
  <td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For">X-Forwarded-For</a></td>
  <td></td>
  <td>Identifies the originating IP address of a client to an intermediary</td>
 </tr>
 <tr>
  <td><code>X-Forwarded-Host</code></td>
  <td>request</td>
  <td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Host">X-Forwarded-Host</a></td>
  <td></td>
  <td>Identifies the original host requested by the client in the Host HTTP request header</td>
 </tr>
 <tr>
  <td><code>X-Intermediary</code></td>
  <td>both</td>
  <td></td>
  <td></td>
  <td>Stamped by an active intermediary that changes the request or the response to alter it's content (see below)</td>
 </tr>
 <tr>
  <td><code>X-Forwarded-Proto</code></td>
  <td>both</td>
  <td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Proto">X-Forwarded-Proto</a></td>
  <td></td>
  <td>Identifies the original protocol used by the client to connect to an intermediary</td>
 </tr>
 <tr>
  <td><code>X-Forwarded-Port</code></td>
  <td>both</td>
  <td></td>
  <td></td>
  <td>Identifies the original port used by the client to connect to an intermediary</td>
 </tr>
 <tr>
  <td><code>X-Forwarded-Prefix</code></td>
  <td>both</td>
  <td></td>
  <td></td>
  <td>This non-standard HTTP header allows applications to be proxied under a sub-URL</td>
 </tr>
</table>

<p>
The request id in <code>X-Request-Id</code> is purely to help connect between
requests and logs/audit trails. The client can assign an id to the request,
and send that in the X-Request-Id header. The server can either use that
id or assign its own, which it returns as the <code>X-Request-Id</code> header
in the response. When the server assigned id is different to the
client assigned id, the server SHOULD also return the <code>X-Correlation-Id</code>
header with the client's original id in it.
</p>
<p>
The HTTP protocol may be routed through an HTTP proxy (e.g. as squid).
Such proxies are transparent to the applications, though implementers
should be alert to the effects of caching, particularly including the
risk of receiving stale content. See the <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec13.html">HTTP specification</a> for further detail
</p>
<p>
Interface engines may also be placed between the consumer and
the provider. These differ from proxies because they actively
alter the content and/or destination of the HTTP exchange and are
not bound by the rules that apply to HTTP proxies. Such agents are allowed,
but SHALL mark the request with an X-Intermediary header to assist with
debugging/troubleshooting. Any agent that modifies an HTTP request or
response content other than under the rules for HTTP proxies SHALL add
a stamp to the HTTP
headers like this:
</p>
<pre>
  X-Intermediary : [identity - usually a FQDN]
</pre>
<p>
End point systems SHALL NOT use this header for any purpose. Its aim
is to assist with system troubleshooting.
</p>


<a name="summary"></a>
<h3>Summary</h3>
<p>
These tables present a summary of the interactions described here.

Note that <i>all</i> requests may include an optional <code>Accept</code> header to indicate the format used for the response (this is even true for <code>DELETE</code> since an OperationOutcome may be returned).
</p>

<table class="grid">
<tr><th>Interaction</th>                <th>Path</th><th colspan="5">Request</th></tr>
<tr><th colspan="2"></th>                                                       <th>Verb</th>           <th>Content-Type</th>   <th>Body</th>     <th>Prefer</th>         <th>Conditional</th></tr>
<tr><td><code>read</code></td>                       <td><code>/[type]/[id]</code></td>                   <td><code>GET<sup>&Dagger;</sup></code></td>            <td>N/A</td>            <td>N/A</td>      <td>N/A</td>     		  <td>O: <code>If-Modified-Since</code>, <code>If-None-Match</code></td></tr>
<tr><td><code>vread</code></td>                      <td><code>/[type]/[id]/_history/[vid]</code></td>    <td><code>GET<sup>&Dagger;</sup></code></td>            <td>N/A</td>            <td>N/A</td>      <td>N/A</td>         	<td>N/A</td></tr>
<tr><td><code>update</code></td>                     <td><code>/[type]/[id]</code></td>                   <td><code>PUT</code></td>            <td>R</td>              <td>Resource</td> <td>O</td>         	<td>O: <code>If-Match</code></td></tr>
<tr><td><code>patch</code></td>                      <td><code>/[type]/[id]</code></td>                   <td><code>PATCH</code></td>          <td>R (may be a patch type)</td>        <td>Patch</td> <td>O</td>         	<td>O: <code>If-Match</code></td></tr>
<tr><td><code>delete</code></td>                     <td><code>/[type]/[id]</code></td>                   <td><code>DELETE</code></td>         <td>N/A</td>            <td>N/A</td>      <td>N/A</td>	         <td>N/A</td></tr>
<tr><td><code>create</code></td>                     <td><code><code>/[type]</code></code></td>                        <td>POST</td>           <td>R</td>              <td>Resource</td> <td>O</td>         <td>O: <code>If-None-Exist</code></td></tr>
<tr><td rowspan="2"><code>search-type</code></td>    <td><code>/[type]?</code></td>                      <td><code>GET</code></td>   <td>N/A</td>                                            <td>N/A</td>        <td>N/A</td>  <td>N/A</td></tr>
<tr>                                                 <td><code>/[type]/_search?</code></td>              <td><code>POST</code></td>  <td><code>application/x-www-form-urlencoded</code></td> <td>form data</td>  <td>N/A</td>  <td>N/A</td></tr>
<tr><td rowspan="2"><code>search-system</code></td>    <td><code>?</code></td>                             <td><code>GET</code></td>   <td>N/A</td>                                            <td>N/A</td>        <td>N/A</td>  <td>N/A</td></tr>
<tr>                                                <td><code>/_search</code></td>                      <td><code>POST</code></td>  <td><code>application/x-www-form-urlencoded</code></td> <td>form data</td>  <td>N/A</td>  <td>N/A</td></tr>
<tr><td rowspan="4"><code>search-compartment</code></td>  <td><code>/[compartment]/[id]/*?</code></td>              <td><code>GET</code></td>   <td>N/A</td>                                            <td>N/A</td>        <td>N/A</td>  <td>N/A</td></tr>
<tr>                                                      <td><code>/[compartment]/[id]/[type]?</code></td>         <td><code>GET</code></td>   <td>N/A</td>                                            <td>N/A</td>        <td>N/A</td>  <td>N/A</td></tr>
<tr>                                                      <td><code>/[compartment]/[id]/_search?</code></td>        <td><code>POST</code></td>  <td><code>application/x-www-form-urlencoded</code></td> <td>form data</td>  <td>N/A</td>  <td>N/A</td></tr>
<tr>                                                      <td><code>/[compartment]/[id]/[type]/_search?</code></td> <td><code>POST</code></td>  <td><code>application/x-www-form-urlencoded</code></td> <td>form data</td>  <td>N/A</td>  <td>N/A</td></tr>
<tr><td><code>capabilities</code></td>               <td><code>/metadata</code></td>                      <td><code>GET<sup>&Dagger;</sup></code></td>            <td>N/A</td>           <td>N/A</td>	   <td>N/A</td>			   	<td>N/A</td></tr>
<tr><td><code>transaction</code></td>                <td><code>/</code></td>                              <td><code>POST</code></td>           <td>R</td>              <td><code>Bundle</code></td>    <td>O</td>        <td>N/A</td></tr>
<tr><td><code>batch</code></td>                      <td><code>/</code></td>                              <td><code>POST</code></td>           <td>R</td>              <td><code>Bundle</code></td>    <td>O</td>        <td>N/A</td></tr>
<tr><td><code>history-instance</code></td>           <td><code>/[type]/[id]/_history</code></td>          <td><code>GET</code></td>            <td>N/A</td>            <td>N/A</td>       <td>N/A</td>         <td>N/A</td></tr>
<tr><td><code>history-type</code></td>               <td><code>/[type]/_history</code></td>               <td><code>GET</code></td>            <td>N/A</td>            <td>N/A</td>       <td>N/A</td>         <td>N/A</td></tr>
<tr><td><code>history-system</code></td>             <td><code>/_history</code></td>                      <td><code>GET</code></td>            <td>N/A</td>            <td>N/A</td>       <td>N/A</td>         <td>N/A</td></tr>
<tr><td rowspan="3">(operation)</td>    <td rowspan="3"><code>/$[name]</code>, <code>/[type]/$[name]</code>
										or <code>/[type]/[id]/$[name]</code></td> 		  	<td><code>POST</code></td>           <td>R</td>         		<td>Parameters</td><td>N/A</td>			<td>N/A</td></tr>
																		<tr>    <td><code>GET</code></td>           	<td>N/A</td>         	<td>N/A</td> 	   <td>N/A</td>  		<td>N/A</td></tr>
																		<tr>    <td><code>POST</code></td>          	<td><code>application/x-www-form-urlencoded</code></td>         	<td>form data</td> 	   <td>N/A</td>  		<td>N/A</td></tr>
</table>

<p>
Notes:
</p>
<ul>
 <li>N/A = not present, R = Required, O = optional</li>
 <li>For operations defined on all resources, including direct access to the meta element, see <a href="resource-operations.html">Resource Operations</a></li>
 <li>For <code>GET</code> operations labelled with <sup>&Dagger;</sup>, <code>HEAD</code> can also be used</li>
</ul>

<table class="grid">
<tr><th>Interaction</th><th colspan="6">Response</th></tr>
<tr><th colspan="1"></th>   <th>Content-Type</th> <th>Body</th>               <th>Location</th> 	    <th>Versioning</th> 					<th>Status Codes</th></tr>
<tr><td><code>read</code></td>               <td>R</td>         <td>R: Resource</td>           <td>N/A</td>   <td>R: <code>ETag</code>, <code>Last-Modified</code></td>		<td><code>200</code>, <code>202</code>, <code>404</code>, <code>410</code><sup>&Dagger;</sup></td></tr>
<tr><td><code>vread</code></td>              <td>R</td>         <td>R: Resource</td>           <td>N/A</td>   <td>R: <code>ETag</code>, <code>Last-Modified</code></td>		<td><code>200</code>, <code>202</code>, <code>404</code>, <code>410</code><sup>&Dagger;</sup></td></tr>
<tr><td><code>update</code></td>             <td>R if body</td> <td>O: Resource (Prefer)</td>  <td>N/A</td>   <td>R: <code>ETag</code>, <code>Last-Modified</code></td>		<td><code>200</code>, <code>201</code>, <code>202</code>, <code>400</code>, <code>404</code>, <code>405</code>, <code>409</code>, <code>412</code>, <code>422</code></td></tr>
<tr><td><code>patch</code></td>              <td>R if body</td> <td>O: Resource (Prefer)</td>  <td>N/A</td>   <td>R: <code>ETag</code>, <code>Last-Modified</code></td>		<td><code>200</code>, <code>201</code>, <code>202</code>, <code>400</code>, <code>404</code>, <code>405</code>, <code>409</code>, <code>412</code>, <code>422</code></td></tr>
<tr><td><code>delete</code></td>             <td>R if body</td> <td>O: OperationOutcome</td>   <td>N/A</td>   <td>N/A</td>							<td><code>200</code>, <code>202</code>, <code>204</code>, <code>404</code>, <code>405</code>, <code>409</code>, <code>412</code></td></tr>
<tr><td><code>create</code></td>             <td>R if body</td> <td>O : Resource (Prefer)</td> <td>R</td>	    <td>R: <code>ETag</code>, <code>Last-Modified</code></td>		<td><code>201</code>, <code>202</code>, <code>400</code>, <code>404</code>, <code>405</code>, <code>422</code></td></tr>
<tr><td><code>search-type</code></td>        <td>R</td>         <td>R: Bundle</td>             <td>N/A</td>   <td>N/A</td>							<td><code>200</code>, <code>202</code>, <code>401</code>?</td></tr>
<tr><td><code>search-system</code></td>      <td>R</td>         <td>R: Bundle</td>             <td>N/A</td>   <td>N/A</td>							<td><code>200</code>, <code>202</code>, <code>401</code>?</td></tr>
<tr><td><code>search-compartment</code></td> <td>R</td>         <td>R: Bundle</td>             <td>N/A</td>   <td>N/A</td>							<td><code>200</code>, <code>202</code>, <code>401</code>?</td></tr>
<tr><td><code>capabilities</code></td>       <td>R</td>         <td>R: CapabilityStatement</td><td>N/A</td>   <td>N/A</td>							<td><code>200</code>, <code>202</code>, <code>404</code></td><sup>&Dagger;</sup></tr>
<tr><td><code>transaction</code></td>        <td>R</td>         <td>R: Bundle</td>             <td>N/A</td>   <td>N/A</td>							<td><code>200</code>, <code>202</code>, <code>400</code>, <code>404</code>, <code>405</code>, <code>409</code>, <code>412</code>, <code>422</code></td></tr>
<tr><td><code>batch</code></td>              <td>R</td>         <td>R: Bundle</td>             <td>N/A</td>   <td>N/A</td>							<td><code>200</code>, <code>202</code>, <code>400</code>, <code>404</code>, <code>405</code>, <code>409</code>, <code>412</code>, <code>422</code></td></tr>
<tr><td><code>history-instance</code></td>   <td>R</td>         <td>R: Bundle</td>             <td>N/A</td>   <td>N/A</td>							<td><code>200</code>, <code>202</code></td></tr>
<tr><td><code>history-type</code></td>       <td>R</td>         <td>R: Bundle</td>             <td>N/A</td>   <td>N/A</td>							<td><code>200</code>, <code>202</code></td></tr>
<tr><td><code>history-all</code></td>        <td>R</td>         <td>R: Bundle</td>             <td>N/A</td>   <td>N/A</td>							<td><code>200</code>, <code>202</code></td></tr>
<tr><td>(operation)</td>   	                 <td>R</td> 			  <td>R: Parameters/Resource</td><td>N/A</td>   <td>N/A</td>			        <td><code>200</code>, <code>202</code> + varies by operation type</td></tr>
</table>

<p>
Notes:
</p>
<ul>
 <li>This table lists the status codes described here, but other status codes are possible as described by the HTTP specification. Additional codes that are likely are server errors and various codes associated with authentication protocols. The <a href="security.html">security page</a> notes several security related issues that may impact which codes to return.</li>
 <li>The returned status code <code>202</code> is applicable when <code>Prefer: respond-async</code> is supplied by the client.</li>
 <li>For <code>GET</code><sup>&Dagger;</sup> operations where <code>HEAD</code> can also be used, the HTTP status codes <code>405</code> and <code>501</code> can also be returned from <code>HEAD</code> operations</li>
</ul>

[%file newfooter%]
</body>
</html>


